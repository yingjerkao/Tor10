

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tor10.UniTensor &mdash; Tor10 0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Tor10
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Symmetry.html">tor10.Symmetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Bond.html">tor10.Bond</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../UniTensor.html">tor10.UniTensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Network.html">tor10.Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linalg.html">tor10.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.html">tor10.nn</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tor10</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tor10.UniTensor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tor10.UniTensor</h1><div class="highlight"><pre>
<span></span><span class="c1">## [DEBUG] &gt;&gt;&gt; </span>
<span class="c1">## Note, set this to True to enable debug section</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1">## &lt;&lt;&lt;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pkl</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">linalg</span>
<span class="kn">from</span> <span class="nn">.Bond</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.Bond</span> <span class="k">import</span> <span class="n">_fx_GetCommRows</span>


<span class="c1">## Developer Note:</span>
<span class="c1">## [KHW]</span>
<span class="c1">## from v0.3+, we deprecate dense Symmetry. </span>
<span class="c1">## Using a is_symm as master switch. </span>
<span class="c1">## Find &quot;[Fusion tree]&quot; keyword for future extend of non-abelian / fermion etc. </span>
<span class="c1">## Find &quot;DEBUG&quot; keywork to comment the debug section when in release!!. </span>

<span class="k">def</span> <span class="nf">_fx_decompress_idx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">accu_offsets</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accu_offsets</span><span class="p">)):</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">accu_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="n">accu_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="UniTensor"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor">[docs]</a><span class="k">class</span> <span class="nc">UniTensor</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_mac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">torch_tensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">braket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sym_mappers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Memory Allocation and Check (_mac)</span>

<span class="sd">            torch_tensor :</span>
<span class="sd">                This is the internal arguments in current version. It should not be directly use, otherwise may cause inconsistence with Bonds and memory layout.</span>
<span class="sd">                    *For Developer:</span>
<span class="sd">                        &gt; The torch_tensor should have the same rank as len(label), and with each bond dimensions strictly the same as describe as in bond in self.bonds.</span>

<span class="sd">            check :</span>
<span class="sd">                This is the internal arguments. It should not be directly use. If False, all the checking across bonds/labels/Storage.shape will be ignore.</span>

<span class="sd">            braket :</span>
<span class="sd">                This is the internal arguments. It should not be directly use. If set, the braket -1 or +1 indicate the bond are BD_KET or BD_BRA. it is handy for calculate reverse quantum flow / blocks when bra-bond is permute to col-space (unmatched braket)</span>

<span class="sd">            sym_mappers:</span>
<span class="sd">                This is the internal arguments. It should not be directly use. It is a tuple, use to pass the shallow permute informations / block mapping information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">braket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_braket</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sym_mappers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sym_mappers</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="c1"># if torch_tensor is None:</span>
            <span class="c1">#    raise TypeError(&quot;UniTensor.__init__&quot;,&quot;[ERROR], pass the interface must accompany with torch_tensor&quot;)</span>

        <span class="k">if</span> <span class="n">torch_tensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch_tensor</span>

<div class="viewcode-block" id="UniTensor.__init__"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bonds</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">is_diag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the constructor of UniTensor.</span>

<span class="sd">        Public Args:</span>

<span class="sd">            bonds:</span>
<span class="sd">                List of bonds.</span>
<span class="sd">                It should be an list or np.ndarray with len(list) being the number of bonds.</span>

<span class="sd">            rowrank:</span>
<span class="sd">                The number of bonds in row-space.</span>
<span class="sd">                The first [rowrank] bonds will be define as the row-space (which means the row space when flatten as Matrix), and the other bonds will be defined as in the col-space (which is the column space when flatten as Matrix).</span>
<span class="sd">                When interprete the memory layout as Matrix, the combine of first rowrank bonds will be the row and the other bond will be column.</span>


<span class="sd">            labels:</span>
<span class="sd">                The label of each bond.</span>
<span class="sd">                1. the number of elements should be the same as the total rank of the tensor, contain no duplicated elements.</span>
<span class="sd">                2. all the label should be integer. if the label is specify as floating point, it will be rounded as integer.</span>

<span class="sd">            device:</span>
<span class="sd">                This should be a [torch.device]. When provided, the tensor will be put on the device (&quot;cpu&quot;, &quot;cuda&quot;, &quot;cuda:x&quot; with x is the GPU-id. See torch.device for further information.)</span>

<span class="sd">            dtype :</span>
<span class="sd">                This should be a [ torch.dtype ].</span>
<span class="sd">                *The default type is float with either float32 or float64 which follows the same internal rule of pytorch. For further information, see pytorch documentation.</span>

<span class="sd">            is_diag:</span>
<span class="sd">                This states if the current UniTensor is a diagonal matrix or not. If True, the Storage will only store diagonal elements.</span>
<span class="sd">                Note that if is_diag=True, then the UniTensor is strictly required to be a square rank-2 tensor.</span>

<span class="sd">            requires_grad:</span>
<span class="sd">                Activate the autograd function for UniTensor. This is the same as torch.Tensor</span>

<span class="sd">            name:</span>
<span class="sd">                This states the name of current UniTensor.</span>

<span class="sd">                </span>
<span class="sd">        Example for how to create a UniTensor:</span>

<span class="sd">            * create a rank-2 untagged UniTensor (matrix) with shape (3,4):</span>
<span class="sd">            &gt;&gt;&gt; a = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4)],rowrank=1)</span>
<span class="sd">            &gt;&gt;&gt; a.Print_diagram(bond_info=True)</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 2</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 0 ____| 3         4 |____ 1  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------      </span>
<span class="sd">            lbl:0 Dim = 3 |</span>
<span class="sd">            REG     :</span>
<span class="sd">            _</span>
<span class="sd">            lbl:1 Dim = 4 |</span>
<span class="sd">            REG     :</span>

<span class="sd">            * create a rank-3 untagged UniTensor with one bond in row-space and two bonds in col-space, shape (3,4,5) and set labels [-3,4,1] for each bond:</span>
<span class="sd">            &gt;&gt;&gt; c = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4),tor10.Bond(5)],rowrank=1,labels=[-3,4,1])</span>
<span class="sd">            &gt;&gt;&gt; c.Print_diagram(bond_info=True)</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                -3 ____| 3         4 |____ 4  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           5 |____ 1  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------      </span>
<span class="sd">            lbl:-3 Dim = 3 |</span>
<span class="sd">            REG     :</span>
<span class="sd">            _</span>
<span class="sd">            lbl:4 Dim = 4 |</span>
<span class="sd">            REG     :</span>
<span class="sd">            _</span>
<span class="sd">            lbl:1 Dim = 5 |</span>
<span class="sd">            REG     :</span>


<span class="sd">            * create a rank-0 UniTensor</span>
<span class="sd">            &gt;&gt;&gt; rk0t = tor10.UniTensor(bonds=[])</span>
<span class="sd">            &gt;&gt;&gt; rk0t.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 0</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------  </span>

<span class="sd">            &gt;&gt;&gt; print(rk0t)</span>
<span class="sd">            Tensor name: </span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor(0., dtype=torch.float64) </span>

<span class="sd">            * create a rank-3 tagged UniTensor with two bonds in row-space and two bonds in col-space, shape (2,3,4,5)</span>
<span class="sd">            &gt;&gt;&gt; bds  = [tor10.Bond(2,tor10.BD_KET),tor10.Bond(3,tor10.BD_KET),tor10.Bond(4,tor10.BD_BRA),tor10.Bond(5,tor10.BD_BRA)]</span>
<span class="sd">            &gt;&gt;&gt; o = tor10.UniTensor(bonds=bds,rowrank=2)</span>
<span class="sd">            &gt;&gt;&gt; o.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">            braket_form : True</span>
<span class="sd">                  |ket&gt;               &lt;bra| </span>
<span class="sd">                       ---------------      </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 0 &gt; __| 2         4 |__ &lt; 2  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 1 &gt; __| 3         5 |__ &lt; 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       ---------------  </span>


<span class="sd">            * note that if the BRA bond is not in the col-space, or KET bond is not in the row-space, the tensor is in the so called &quot;non-braket_form, which will have a * symbol indicating the mismatch.&quot;</span>
<span class="sd">            &gt;&gt;&gt; bd2 = [tor10.Bond(2,tor10.BD_KET),tor10.Bond(5,tor10.BD_BRA),tor10.Bond(4,tor10.BD_BRA),tor10.Bond(3,tor10.BD_KET)]</span>
<span class="sd">            &gt;&gt;&gt; c_mismatch = tor10.UniTensor(bonds=bd2,rowrank=2)</span>
<span class="sd">            &gt;&gt;&gt; c_mismatch.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">            braket_form : False</span>
<span class="sd">                  |ket&gt;               &lt;bra| </span>
<span class="sd">                       ---------------      </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 0 &gt; __| 2         4 |__ &lt; 2  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 1 &lt;*__| 5         3 |__*&gt; 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       ---------------  </span>


<span class="sd">            * create a rank-2 UniTensor with one inbond, one outbond, shape (3,4) on GPU-0:</span>
<span class="sd">            &gt;&gt;&gt; d = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4)],rowrank=1,device=torch.device(&quot;cuda:0&quot;))</span>

<span class="sd">            * create a diagonal 6x6 rank-2 tensor(matrix):</span>
<span class="sd">              Note that if is_diag is True, rowrank must be 1.</span>
<span class="sd">            &gt;&gt;&gt; e = tor10.UniTensor(bonds=[tor10.Bond(6),tor10.Bond(6)],rowrank=1,is_diag=True)</span>

<span class="sd">            Note that when is_diag is set to True, the UniTensor should be a square matrix.</span>

<span class="sd">            * create a rank-3 UniTensor with two bonds in row-space and one bond in col-space, and single precision:</span>
<span class="sd">            &gt;&gt;&gt; f = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4),tor10.Bond(5)],rowrank=2,labels=[-3,4,1],dtype=torch.float32)</span>

<span class="sd">            * create a rank-3 UniTensor with U1 symmetry:</span>
<span class="sd">            &gt;&gt;&gt; bd_sym_1 = tor10.Bond(3,tor10.BD_KET,qnums=[[0],[1],[2]])</span>
<span class="sd">            &gt;&gt;&gt; bd_sym_2 = tor10.Bond(4,tor10.BD_KET,qnums=[[-1],[2],[0],[2]])</span>
<span class="sd">            &gt;&gt;&gt; bd_sym_3 = tor10.Bond(5,tor10.BD_BRA,qnums=[[4],[2],[-1],[5],[1]])</span>
<span class="sd">            &gt;&gt;&gt; symT = tor10.UniTensor(bonds=[bd_sym_1,bd_sym_2,bd_sym_3],rowrank=2,labels=[10,11,12])</span>
<span class="sd">            &gt;&gt;&gt; symT.Print_diagram(bond_info=True)</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: True</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            braket_form : True</span>
<span class="sd">                  |ket&gt;               &lt;bra| </span>
<span class="sd">                       ---------------      </span>
<span class="sd">                       |             |     </span>
<span class="sd">                10 &gt; __| 3         5 |__ &lt; 12 </span>
<span class="sd">                       |             |     </span>
<span class="sd">                11 &gt; __| 4           |        </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       ---------------    </span>
<span class="sd">            lbl:10 Dim = 3 |</span>
<span class="sd">            KET     : U1::  +2 +1 +0</span>
<span class="sd">            _</span>
<span class="sd">            lbl:11 Dim = 4 |</span>
<span class="sd">            KET     : U1::  +2 +2 +0 -1</span>
<span class="sd">            _        </span>
<span class="sd">            lbl:12 Dim = 5 |</span>
<span class="sd">            BRA     : U1::  +5 +4 +2 +1 -1</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## general property:---------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1">## bonds:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">))])</span>

        <span class="c1"># labels: </span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="c1">## checking :</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="c1"># check # of labels consist with bond.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;labels size is not consistence with the rank&quot;</span><span class="p">)</span>
            <span class="c1"># Bonds:</span>
            <span class="k">if</span> <span class="n">rowrank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rowrank</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rowrank</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;the rowrank should be &gt;=0 and &lt; # of bonds&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1">## check duplicate label</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;labels contain duplicate element.&quot;</span><span class="p">)</span>

                <span class="c1">## check qnums:</span>
                <span class="n">isSymm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([(</span><span class="n">bd</span><span class="o">.</span><span class="n">qnums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">bd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isSymm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;the bonds are not consistent. Cannot have mixing bonds of with and without symmetry (qnums).&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_diag</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;the scalar tensor (rank-0) cannot have is_diag=True.&quot;</span><span class="p">)</span>

        <span class="c1">## braket, is_braket:</span>
        <span class="c1"># is_tag = False if len(self.bonds)==0 else (self.bonds[0].bondType != BD_REG)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="n">rowrank</span>

        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">!=</span> <span class="n">BD_REG</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">BondType</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">))],</span>
                                           <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s2">&quot;[ERROR] for UniTensor init with all the bond are regular, rowrank should be provided&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rowrank</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_braket</span><span class="p">()</span>

        <span class="c1">## check is_symm:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">qnums</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">=</span> <span class="n">is_diag</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1">## non-symmetry properties:----------------------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">=</span> <span class="n">is_diag</span>
            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_diag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;is_diag=True require Tensor rank==2&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;is_diag=True require Tensor rank==2, with 1 inbond and 1 outbond (rowrank=1)&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;is_diag=True require Tensor to be square rank-2&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">DALL</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">))]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">DALL</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">DALL</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

            <span class="c1"># self.Storage = torch_tensor</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## Symmetry properties-------------------------------:</span>
            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">qnums</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">bd</span><span class="o">.</span><span class="n">nsym</span> <span class="k">for</span> <span class="n">bd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;the number of symmetry type for symmetry bonds doesn&#39;t match.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;[ERROR] tensor with symmetry must have at least one rank for row space and one rank for column space&quot;</span><span class="p">)</span>

                <span class="n">nket</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_BRA</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">nket</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nket</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;[ERROR] tensor with symmetry must have at least one bra-bond and one ket-bond&quot;</span><span class="p">)</span>

            <span class="c1">## only activate when symmetry is on.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## this follow memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## this follow memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## this follow memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## this follow memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## memory idx to real idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## real idx to memory index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## this follows memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## this follows memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## this follows real Tensor, not memory!!!</span>

            <span class="c1">## memory contiguous mapper this </span>
            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>

                <span class="c1"># calc offsets</span>
                <span class="n">accu_off</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                    <span class="n">accu_off</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="n">tmp</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span>
                <span class="n">accu_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accu_off</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu_off</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]</span> <span class="o">/</span> <span class="n">accu_off</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span> <span class="o">=</span> <span class="n">accu_off</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]</span>
                <span class="k">del</span> <span class="n">accu_off</span>

                <span class="c1">## mapper </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">)</span>

                <span class="c1">## Get common qnums for in and out b</span>
                <span class="n">b_tqin</span><span class="p">,</span> <span class="n">b_tqout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetTotalQnums</span><span class="p">(</span><span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">tqin_uni</span> <span class="o">=</span> <span class="n">b_tqin</span><span class="o">.</span><span class="n">GetUniqueQnums</span><span class="p">()</span>
                <span class="n">tqout_uni</span> <span class="o">=</span> <span class="n">b_tqout</span><span class="o">.</span><span class="n">GetUniqueQnums</span><span class="p">()</span>
                <span class="n">C</span> <span class="o">=</span> <span class="n">_fx_GetCommRows</span><span class="p">(</span><span class="n">tqin_uni</span><span class="p">,</span> <span class="n">tqout_uni</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.__init__&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;[ERROR] no vaild block in current Tensor. please check total qnums in total bra/ket bonds have at least one same set of qnums.&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">b_tqin</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">b_tqout</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)):</span>
                    <span class="n">comm</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="n">idx_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">b_tqin</span><span class="o">.</span><span class="n">qnums</span> <span class="o">==</span> <span class="n">comm</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">idx_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">b_tqout</span><span class="o">.</span><span class="n">qnums</span> <span class="o">==</span> <span class="n">comm</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_in</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_out</span><span class="p">)),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>

                    <span class="c1">## interface</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_fx_decompress_idx</span><span class="p">(</span><span class="n">idx_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">[</span><span class="n">idx_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">[</span><span class="n">idx_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_in</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

                    <span class="c1">## interface</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_fx_decompress_idx</span><span class="p">(</span><span class="n">idx_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">[</span><span class="n">idx_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">[</span><span class="n">idx_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_out</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span> <span class="o">=</span> <span class="n">C</span>

        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">requires_grad</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">tag_braket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">b_in</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b_in</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_KET</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">b_out</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b_out</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_BRA</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BondType</span><span class="p">[</span><span class="n">BD_BRA</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># check:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;[ERROR] tags must match the rank of bonds.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="o">==</span> <span class="n">BD_REG</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rags</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;[ERROR] tags cannot contain BD_REG&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BondType</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">b</span><span class="p">]])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">untag_braket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot untag bra/ket on the bonds for symmetry tensor.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_REG</span>

    <span class="k">def</span> <span class="nf">_check_braket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This is internal function!!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_BRA</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="UniTensor.is_braket_form"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.is_braket_form">[docs]</a>    <span class="k">def</span> <span class="nf">is_braket_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Return if the current tensor is in braket_form. It can only be called on a tagged UniTensor (with or without symmetry)</span>

<span class="sd">        Return:</span>

<span class="sd">            bool.     </span>
<span class="sd">                </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] for a tensor with regular bonds, there is no property of barket.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span></div>

<div class="viewcode-block" id="UniTensor.braket_form"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.braket_form">[docs]</a>    <span class="k">def</span> <span class="nf">braket_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permute the UniTensor to bra-ket form. </span>

<span class="sd">        [Tech.Note] the permuted UniTensor can be non-contiguous depending on the underlying memory layout. </span>

<span class="sd">        Return :</span>
<span class="sd">            self</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] for a tensor with regular bonds, there is no property of barket.&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
        <span class="n">Nin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="n">Nin</span><span class="p">,</span> <span class="n">by_label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.SetLabel"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.SetLabel">[docs]</a>    <span class="k">def</span> <span class="nf">SetLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newLabel</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a new label for the bond at index :idx:</span>

<span class="sd">        Args:</span>

<span class="sd">            newLabel: The new label, it should be an integer.</span>

<span class="sd">            idx     : The index of the bond. when specified, the label of the bond at this index will be changed.</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; g = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4)],rowrank=1,labels=[5,6])</span>
<span class="sd">            &gt;&gt;&gt; g.labels</span>
<span class="sd">            [5 6]</span>


<span class="sd">            Set &quot;-1&quot; to replace the original label &quot;6&quot; at index 1</span>

<span class="sd">            &gt;&gt;&gt; g.SetLabel(-1,1)</span>
<span class="sd">            &gt;&gt;&gt; g.labels</span>
<span class="sd">            [5 -1]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">newLabel</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetLabel&quot;</span><span class="p">,</span> <span class="s2">&quot;newLabel and idx must be int.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetLabel&quot;</span><span class="p">,</span> <span class="s2">&quot;idx exceed the number of bonds.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newLabel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetLabel&quot;</span><span class="p">,</span> <span class="s2">&quot;newLabel [</span><span class="si">%d</span><span class="s2">] already exists in the current UniTensor.&quot;</span> <span class="o">%</span> <span class="n">newLabel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">newLabel</span></div>

<div class="viewcode-block" id="UniTensor.SetLabels"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.SetLabels">[docs]</a>    <span class="k">def</span> <span class="nf">SetLabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newlabels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set new labels for all the bonds.</span>

<span class="sd">        Args:</span>

<span class="sd">            newLabels: The list of new labels, it should be a list or numpy array with size equal to the number of bonds of the UniTensor.</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; g = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4)],rowrank=1,labels=[5,6])</span>
<span class="sd">            &gt;&gt;&gt; g.labels</span>
<span class="sd">            [5 6]</span>

<span class="sd">            Set new_label=[-1,-2] to replace the original label [5,6].</span>

<span class="sd">            &gt;&gt;&gt; new_label=[-1,-2]</span>
<span class="sd">            &gt;&gt;&gt; g.SetLabels(new_label)</span>
<span class="sd">            &gt;&gt;&gt; g.labels</span>
<span class="sd">            [-1 -2]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newlabels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">newlabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newlabels</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">newlabels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetLabels&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;the length of newlabels does not match with the rank of UniTensor.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">newlabels</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newlabels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetLabels&quot;</span><span class="p">,</span> <span class="s2">&quot;the newlabels contain duplicate entries.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">newlabels</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.SetName"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.SetName">[docs]</a>    <span class="k">def</span> <span class="nf">SetName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the name of the UniTensor</span>

<span class="sd">        Args:</span>

<span class="sd">            name:</span>
<span class="sd">                a string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.str&quot;</span><span class="p">,</span> <span class="s2">&quot;the name should be a string.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.SetElem"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.SetElem">[docs]</a>    <span class="k">def</span> <span class="nf">SetElem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given 1D array of elements, set the elements stored in tensor as the same as the given ones. Note that elem can only be python-list or numpy</span>

<span class="sd">        Args:</span>

<span class="sd">            elem:</span>
<span class="sd">                The elements to be replace the content of the current UniTensor. It should be a 1D array.</span>
<span class="sd">                **Note** if the UniTensor is a tensor with symmetry, one should use UniTensor.PutBlock to set the elements.</span>

<span class="sd">        Example:</span>
<span class="sd">        ::</span>
<span class="sd">            Sz = tor10.UniTensor(bonds=[tor10.Bond(2),tor10.Bond(2)],rowrank=1,</span>
<span class="sd">                              dtype=torch.float64,</span>
<span class="sd">                              device=torch.device(&quot;cpu&quot;))</span>
<span class="sd">            Sz.SetElem([1, 0,</span>
<span class="sd">                        0,-1 ])</span>


<span class="sd">        &gt;&gt;&gt; print(Sz)</span>
<span class="sd">        Tensor name: </span>
<span class="sd">        is_diag    : False</span>
<span class="sd">        tensor([[ 1.,  0.],</span>
<span class="sd">                [ 0., -1.]], dtype=torch.float64)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetElem&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR]  elem can only be python-list or numpy&quot;</span><span class="p">)</span>

        <span class="c1">## Qnum_ipoint [OKv03]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetElem&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] the TN that has symm should use PutBlock.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">numel</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetElem&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] number of elem is not equal to the # of elem in the tensor.&quot;</span><span class="p">)</span>

        <span class="n">raw_elems</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_elems</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.SetElem&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] can only accept 1D array of elements.&quot;</span><span class="p">)</span>

        <span class="n">my_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">my_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">my_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">raw_elems</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">my_type</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">my_shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">my_device</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.SetRowRank"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.SetRowRank">[docs]</a>    <span class="k">def</span> <span class="nf">SetRowRank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_rowrank</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the RowRank while keep the tensor indices.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">            </span>
<span class="sd">                new_rowrank: </span>
<span class="sd">                    should be a unsigned int. </span>
<span class="sd">                </span>
<span class="sd">                    [Note] for UniTensor with symmetry, it should have at least one bond in row-space and one bond in col-space. which means rowrank must &gt;=1 and &lt;= (rank of UniTensor)-1 </span>

<span class="sd">            Return:</span>

<span class="sd">                self</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1">##check:</span>
            <span class="k">if</span> <span class="n">new_rowrank</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">new_rowrank</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;SetRowRank for a tensor with symmetry must have at least 1 bond in row-space and 1 bond in col-space&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_rowrank</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_rowrank</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">new_rowrank</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERRROR]&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Invalid Rowrank. Must &gt;=0 and &lt;= rank of tensor for non-symmetry UniTensor&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_rowrank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_braket</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.Todense_"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Todense_">[docs]</a>    <span class="k">def</span> <span class="nf">Todense_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the current UniTensor to dense matrix.</span>
<span class="sd">            [v0.3+] This only affect on UniTensor with non-symmetry with diag=True.</span>

<span class="sd">        Return:</span>
<span class="sd">            self</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; a = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(3)],rowrank=1,is_diag=True)</span>
<span class="sd">            &gt;&gt;&gt; a.SetElem([1,2,3])</span>
<span class="sd">            &gt;&gt;&gt; print(a.is_diag)</span>
<span class="sd">            True</span>

<span class="sd">            &gt;&gt;&gt; print(a)</span>
<span class="sd">            Tensor name: </span>
<span class="sd">            is_diag    : True</span>
<span class="sd">            tensor([1., 2., 3.], dtype=torch.float64)</span>

<span class="sd">            &gt;&gt;&gt; a.Todense_()</span>
<span class="sd">            &gt;&gt;&gt; print(a.is_diag)</span>
<span class="sd">            False</span>

<span class="sd">            &gt;&gt;&gt; print(a)</span>
<span class="sd">            Tensor name: </span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor([[1., 0., 0.],</span>
<span class="sd">                    [0., 2., 0.],</span>
<span class="sd">                    [0., 0., 3.]], dtype=torch.float64)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Todense()&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] cannot transform to dense for UniTensor with symmetry&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.Todense"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Todense">[docs]</a>    <span class="k">def</span> <span class="nf">Todense</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a densed version of current UniTensor. This only affect on UniTensor with non-symmetry with is_diag=True.</span>
<span class="sd">        </span>
<span class="sd">            [Note] for UniTensor with Symmetry, Todense cannot be called.</span>

<span class="sd">        Return:</span>
<span class="sd">            new UniTensor if current tensor is_diag=True, otherwise return self.</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; a = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(3)],rowrank=1,is_diag=True)</span>
<span class="sd">            &gt;&gt;&gt; print(a.is_diag)</span>
<span class="sd">            True</span>

<span class="sd">            &gt;&gt;&gt; dense_a = a.Todense()</span>
<span class="sd">            &gt;&gt;&gt; print(dense_a.is_diag)</span>
<span class="sd">            False</span>

<span class="sd">            &gt;&gt;&gt; print(a.is_diag)</span>
<span class="sd">            True</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Todense()&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] cannot transform to dense for UniTensor with symmetry&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">Todense_</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.to_"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.to_">[docs]</a>    <span class="k">def</span> <span class="nf">to_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the current UniTensor to device</span>

<span class="sd">        Args:</span>

<span class="sd">            device:</span>
<span class="sd">                This should be an [torch.device]</span>
<span class="sd">                torch.device(&quot;cpu&quot;) for put the tensor on host (cpu)</span>
<span class="sd">                torch.device(&quot;cuda:x&quot;) for put the tensor on GPU with index x</span>

<span class="sd">        Return:</span>
<span class="sd">            </span>
<span class="sd">            self</span>

<span class="sd">        Example:</span>

<span class="sd">            Construct a tensor (default is on cpu)</span>

<span class="sd">            &gt;&gt;&gt; a = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4)],rowrank=1)</span>

<span class="sd">            Set to GPU.</span>

<span class="sd">            &gt;&gt;&gt; a.to_(torch.device(&quot;cuda:0&quot;))</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR] UniTensor.to()&quot;</span><span class="p">,</span> <span class="s2">&quot;only support device argument in this version as torch.device&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="n">device</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.to"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.to">[docs]</a>    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the current UniTensor to device. If device is not the same with current tensor, return a new UniTensor, otherwise return self.</span>

<span class="sd">        Args:</span>

<span class="sd">            device:</span>
<span class="sd">                This should be an [torch.device]</span>
<span class="sd">                torch.device(&quot;cpu&quot;) for put the tensor on host (cpu)</span>
<span class="sd">                torch.device(&quot;cuda:x&quot;) for put the tensor on GPU with index x</span>

<span class="sd">        Return:</span>
<span class="sd">            </span>
<span class="sd">            self if the device if the same as current UniTensor. Otherwise, return a new UniTensor</span>

<span class="sd">        Example:</span>

<span class="sd">            Construct a tensor (default is on cpu)</span>

<span class="sd">            &gt;&gt;&gt; a = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4)],rowrank=1)</span>

<span class="sd">            Set to GPU.</span>

<span class="sd">            &gt;&gt;&gt; b = a.to(torch.device(&quot;cuda:0&quot;))</span>
<span class="sd">            &gt;&gt;&gt; print(b is a)</span>
<span class="sd">            False</span>

<span class="sd">            &gt;&gt;&gt; b = a.to(torch.device(&quot;cpu&quot;))</span>
<span class="sd">            &gt;&gt;&gt; print(b is a)</span>
<span class="sd">            True</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR] UniTensor.to()&quot;</span><span class="p">,</span> <span class="s2">&quot;only support device argument in this version as torch.device&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="n">device</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">to_</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.Print_diagram"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Print_diagram">[docs]</a>    <span class="k">def</span> <span class="nf">Print_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bond_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the beauty print of the tensor diagram. Including the information for the placeing device</span>
<span class="sd">        ::</span>
<span class="sd">            1.The left hand side is always the in-bonds,representing the row-space when flatten as Matrix; the right hand side is always the Out-bonds, representing the column-space when flatten as Matrix.</span>
<span class="sd">            2.The number attach to the out-side of each leg is the Bond-dimension.</span>
<span class="sd">            3.The number attach to the in-side of each leg is the label.</span>
<span class="sd">            4.if all the bra-bonds are in row-space (in-bonds), and all ket-bonds are in col-space (out-bonds), the tensor is in &quot;braket_form&quot;. </span>
<span class="sd">            5.if one permute bra-bonds that should be in-bonds to out-bonds, this will put the UniTensor in a &quot;non-braket_form&quot;. the bond will have a &quot;*&quot; symbol on it. </span>


<span class="sd">        Args:</span>
<span class="sd">        </span>
<span class="sd">            bond_info [default: False]</span>

<span class="sd">                if set to True, the info of each bond will be printed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tensor Name : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tensor Rank : </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;has_symmetry: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;on device     : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;on device     : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;is_diag       : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span><span class="p">))</span>

        <span class="n">Nin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span>
        <span class="n">Nout</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span>
        <span class="k">if</span> <span class="n">Nin</span> <span class="o">&gt;</span> <span class="n">Nout</span><span class="p">:</span>
            <span class="n">vl</span> <span class="o">=</span> <span class="n">Nin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vl</span> <span class="o">=</span> <span class="n">Nout</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;braket_form : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      |ket&gt;               &lt;bra| &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           ---------------      &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vl</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           |             |     &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Nin</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">]:</span>
                        <span class="n">bks</span> <span class="o">=</span> <span class="s2">&quot;&gt; &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bks</span> <span class="o">=</span> <span class="s2">&quot;&lt;*&quot;</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">__&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bks</span><span class="p">)</span>
                    <span class="n">llbl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%-3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;        &quot;</span>
                    <span class="n">llbl</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Nout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">Nin</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">]:</span>
                        <span class="n">bks</span> <span class="o">=</span> <span class="s2">&quot;*&gt;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bks</span> <span class="o">=</span> <span class="s2">&quot; &lt;&quot;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="s2">&quot;__</span><span class="si">%s</span><span class="s2"> </span><span class="si">%-3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">Nin</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
                    <span class="n">rlbl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">Nin</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="s2">&quot;        &quot;</span>
                    <span class="n">rlbl</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">%s</span><span class="s2">| </span><span class="si">%s</span><span class="s2">     </span><span class="si">%s</span><span class="s2"> |</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">llbl</span><span class="p">,</span> <span class="n">rlbl</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           |             |     &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           ---------------     &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            -------------      &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           /             \     &quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           |             |     &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Nin</span><span class="p">:</span>
                    <span class="n">bks</span> <span class="o">=</span> <span class="s2">&quot;__&quot;</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">__&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bks</span><span class="p">)</span>
                    <span class="n">llbl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%-3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;        &quot;</span>
                    <span class="n">llbl</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Nout</span><span class="p">:</span>
                    <span class="n">bks</span> <span class="o">=</span> <span class="s2">&quot;__&quot;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="s2">&quot;__</span><span class="si">%s</span><span class="s2"> </span><span class="si">%-3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">Nin</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
                    <span class="n">rlbl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">Nin</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="s2">&quot;        &quot;</span>
                    <span class="n">rlbl</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">%s</span><span class="s2">| </span><span class="si">%s</span><span class="s2">     </span><span class="si">%s</span><span class="s2"> |</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">llbl</span><span class="p">,</span> <span class="n">rlbl</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           \             /     &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            -------------      &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bond_info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lbl:</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tensor name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;braket_form : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Symmetry]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Contiguous</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">out</span>

                <span class="c1">## DEBUG &gt;&gt;&gt;</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG]&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real memory:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">)</span>
                <span class="c1">## &lt;&lt;&lt;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;is_diag    : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tensor name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;braket_form : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Symmetry]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Contiguous</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">out</span>

                <span class="c1">## DEBUG &gt;&gt;&gt;</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real memory:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">)</span>
                <span class="c1">## &lt;&lt;&lt;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;is_diag    : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;UniTensor with symmetry doesn&#39;t have property len&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

<div class="viewcode-block" id="UniTensor.__eq__"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Compare two UniTensor.</span>
<span class="sd">            ::</span>
<span class="sd">                a == b</span>

<span class="sd">            where a &amp; b are UniTensors.</span>

<span class="sd">            Note that this will only compare the shape of Storage. Not the content of torch tensor.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)))</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)))):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="n">iss</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iss</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>
                <span class="n">iss</span> <span class="o">=</span> <span class="n">iss</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">iss</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bond.__eq__&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] invalid comparison between Bond object and other type class.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the device of UniTensor</span>
<span class="sd">            </span>
<span class="sd">            Return:</span>

<span class="sd">                torch.device</span>
<span class="sd">           </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the device of UniTensor</span>
<span class="sd">            </span>
<span class="sd">            Return:</span>
<span class="sd">                torch.type </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">dtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the shape of UniTensor</span>

<span class="sd">            Return:</span>

<span class="sd">                torch.Size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1">## what to return ?</span>
            <span class="c1"># raise Exception(&quot;[DEvelope]&quot;)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1">## Fill :</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.__getitem__&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] cannot use [] to getitem from a block-form tensor. Use get block first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">From_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">rowrank</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.__setitem__&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] cannot use [] to setitem from a block-form tensor. Use get block first.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="UniTensor.item"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.item">[docs]</a>    <span class="k">def</span> <span class="nf">item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the python scalar from a UniTensor with one element</span>

<span class="sd">        Return:</span>
<span class="sd">            python scalar</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.item&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] cannot operate item() on symmetry tensor&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.item&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;[ERROR] only one-element tensors can be converted to Python scalars.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>

    <span class="c1">## Math ::</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot + two symm and non-symm UniTensor &quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot + two symm tensors that have different symmetry structure.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                             <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                             <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>


                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Two symmetry tensors can only add when both are contiguous.</span><span class="se">\n</span><span class="s2"> suggestion: Call .Contiguous() or .Contiguous_() before add&quot;</span><span class="p">)</span>



            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot add non-braket-tag tensor with tagged tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">is_diag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                             <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>


                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                             <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                                 <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">),</span>
                                 <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                         <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">+</span> <span class="n">other</span><span class="p">,</span>
                         <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1">## U + U is handled by __add__, so we only need to process x + U here.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                     <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="n">other</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                     <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">other</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                     <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;[Cannot subtract symmetric and non-symmetric UniTensors]&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot subtract symmetric tensors with different symmetry structure.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                             <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                             <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Two symmetry tensors can only sub when both are contiguous.</span><span class="se">\n</span><span class="s2"> suggestion: Call .Contiguous() or .Contiguous_() before sub&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot sub non-braket-tag tensor with tagged tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">is_diag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                             <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                             <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                                 <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                                 <span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-</span> <span class="n">other</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                         <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>

                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">-</span> <span class="n">other</span><span class="p">,</span>
                         <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                     <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="n">other</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                     <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                     <span class="n">torch_tensor</span><span class="o">=</span><span class="n">other</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span>

    <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="UniTensor.Whole_transpose"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Whole_transpose">[docs]</a>    <span class="k">def</span> <span class="nf">Whole_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the UniTensor is tagged, exchange the bra/ket tags on each bond, and transpose (rowspace and colspace) by referencing to the &quot;rowrank&quot;.</span>
<span class="sd">            </span>
<span class="sd">            Return:</span>
<span class="sd">                UniTensor, shared the same type with each bond&#39;s tag bra &lt;-&gt; ket exchanged.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1">## symmetry Tensor:</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="n">BD_KET</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_BRA</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_KET</span>
            <span class="n">out</span><span class="o">.</span><span class="n">braket</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span> <span class="o">-</span><span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">## untagged tensor</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span> <span class="o">-</span><span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## tagged nonsymm Tensor:                </span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="n">BD_KET</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_BRA</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_KET</span>
                <span class="n">out</span><span class="o">.</span><span class="n">braket</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span> <span class="o">-</span><span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot * two symm and non-symm UniTensor&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot * two symm tensors that have different symmetry structure.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                             <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                             <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Two symmetry tensors can only mul when both are contiguous.</span><span class="se">\n</span><span class="s2"> suggestion: Call .Contiguous() or .Contiguous_() before mul&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot mul non-braket-tag tensor with tagged tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">is_diag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                             <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                             <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                                 <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">),</span>
                                 <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">other</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                         <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">*</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                     <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="n">other</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                     <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">other</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                     <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">def</span> <span class="nf">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1"># raise Exception(&quot;[Develope][check impl]&quot;)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                     <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">**</span> <span class="n">other</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                     <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">tmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>

            <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span> <span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">**</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot / two symm and non-symm UniTensor.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot / two symm tensors that have different symmetry structure.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                             <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                             <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Two symmetry tensors can only mul when both are contiguous.</span><span class="se">\n</span><span class="s2"> suggestion: Call .Contiguous() or .Contiguous_() before mul&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">is_braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot / non-braket-tag tensor with tagged tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">is_diag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                                 <span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">,</span>
                                 <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">),</span>
                                 <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                                 <span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                         <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tmp</span>

    <span class="c1">## This is the same function that behaves as the memberfunction.</span>
<div class="viewcode-block" id="UniTensor.Svd"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Svd">[docs]</a>    <span class="k">def</span> <span class="nf">Svd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This is the member function of Svd, see tor10.linalg.Svd()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Svd&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] cannot perform Svd on a symmetry,block-form tensor. use GetBlock() first and perform svd on the Block.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Svd&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] cannot perform Svd on a bra-ket tagged tensor.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linalg</span><span class="o">.</span><span class="n">Svd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.Svd_truncate"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Svd_truncate">[docs]</a>    <span class="k">def</span> <span class="nf">Svd_truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keepdim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This is the member function of Svd_truncate, see tor10.linalg.Svd_truncate()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Svd_truncate&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] cannot perform Svd on a symmetry,block-form tensor. use GetBlock() first and perform svd on the Block.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linalg</span><span class="o">.</span><span class="n">Svd_truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keepdim</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.Norm"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Norm">[docs]</a>    <span class="k">def</span> <span class="nf">Norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This is the member function of Norm, see tor10.linalg.Norm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Norm&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] cannot perform Norm on a symmetry,block-form tensor. use GetBlock() first and perform svd on the Block.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linalg</span><span class="o">.</span><span class="n">Norm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.Det"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Det">[docs]</a>    <span class="k">def</span> <span class="nf">Det</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This is the member function of Det, see tor10.linalg.Det</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Det&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] cannot perform Det on a symmetry, block-form tensor. use GetBlock() first and perform det on the Block.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linalg</span><span class="o">.</span><span class="n">Det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.Matmul"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Matmul">[docs]</a>    <span class="k">def</span> <span class="nf">Matmul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This is the member function of Matmul, see tor10.linalg.Matmul</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Matmul&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] cannot perform MatMul on a symmetry, block-form tensor. use GetBlock() first and perform matmul on the Block.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linalg</span><span class="o">.</span><span class="n">Matmul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

    <span class="c1">## Extended Assignment:</span>
    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot += symm and non-symm UniTensors&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot + two symm tensors that have different symmetry structure.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Two symmetry tensors can only add when both are contiguous.</span><span class="se">\n</span><span class="s2"> suggestion: Call .Contiguous() or .Contiguous_() before add&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot += non-braket-tag tensor with tagged tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">+=</span> <span class="n">other</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot -= symm and non-symm UniTensors&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot - two symm tensors that have different symmetry structure.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-=</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Two symmetry tensors can only sub when both are contiguous.</span><span class="se">\n</span><span class="s2"> suggestion: Call .Contiguous() or .Contiguous_() before sub&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot -= non-braket-tag tensor with tagged tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">-=</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">-=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-=</span> <span class="n">other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">-=</span> <span class="n">other</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot *= symm and non-symm UniTensors&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot * two symm tensors that have different symmetry structure.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Two symmetry tensors can only mul when both are contiguous.</span><span class="se">\n</span><span class="s2"> suggestion: Call .Contiguous() or .Contiguous_() before mul&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR]&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot -= non-braket-tag tensor with tagged tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">Storage</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*=</span> <span class="n">other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">*=</span> <span class="n">other</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1">## Miscellaneous</span>
<div class="viewcode-block" id="UniTensor.Rand"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Rand">[docs]</a>    <span class="k">def</span> <span class="nf">Rand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Randomize the UniTensor.</span>

<span class="sd">            Note that in current version, only a UniTensor without symmetry quantum numbers can be randomized.</span>

<span class="sd">        Return:</span>
<span class="sd">            self</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># v0.3+ OK.</span>
        <span class="n">_Randomize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.CombineBonds"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.CombineBonds">[docs]</a>    <span class="k">def</span> <span class="nf">CombineBonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_to_combine</span><span class="p">,</span> <span class="n">new_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">permute_back</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">by_label</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function combines the bonds in input UniTensor [a] by the specified labels [label].</span>

<span class="sd">        [Note][v0.3+] that ket-bonds can only be combine with ket-bonds, bra-bonds can only combine with bra-bonds.</span>

<span class="sd">        Args:</span>

<span class="sd">            labels_to_combine:</span>
<span class="sd">                labels that to be combined. It should be a int list / numpy array of the label. All the bonds with specified labels in the current UniTensor  will be combined</span>

<span class="sd">            new_label [default=None]</span>
<span class="sd">                This should be an integer, for floating point number, it will be truncated to integer.</span>

<span class="sd">                if new_label is set to None, the combined bond will have label as the bond in the to-be-combined bonds that has the smallest LABEL in input tensor.</span>

<span class="sd">                if new_label is set, the combined bond will have label [new_label]</span>
<span class="sd">        </span>
<span class="sd">            permuted_back[False]:</span>
<span class="sd">                this state if the combine bond should be permuted back or not. If false, the combined bond will always presented as the first bond.</span>


<span class="sd">        Example:</span>

<span class="sd">            1. Combine Bond for an non-symmetric tensor.</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(5),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            &gt;&gt;&gt; x = tor10.UniTensor(bonds=bds_x, rowrank=2, labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; y = tor10.UniTensor(bonds=bds_x, rowrank=2, labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 5         3 |____ 5  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 3 ____| 5           |        </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------      </span>
<span class="sd">            lbl:4 Dim = 5 |</span>
<span class="sd">            REG     :</span>
<span class="sd">            _</span>
<span class="sd">            lbl:3 Dim = 5 |</span>
<span class="sd">            REG     :</span>
<span class="sd">            _</span>
<span class="sd">            lbl:5 Dim = 3 |</span>
<span class="sd">            REG     :</span>


<span class="sd">            * combine bond with label &quot;3&quot; into &quot;5&quot;</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; x.CombineBonds([5,3])</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 2</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 5        15 |____ 5  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------      </span>
<span class="sd">            lbl:4 Dim = 5 |</span>
<span class="sd">            REG     :</span>
<span class="sd">            _</span>
<span class="sd">            lbl:5 Dim = 15 |</span>
<span class="sd">            REG     :</span>


<span class="sd">            * combine bond with label &quot;5&quot; into &quot;3&quot;</span>

<span class="sd">            &gt;&gt;&gt; y.CombineBonds([3,5])</span>
<span class="sd">            &gt;&gt;&gt; y.Print_diagram()</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 2</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 5           |        </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 3 ____| 15          |        </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------      </span>
<span class="sd">            lbl:4 Dim = 5 |</span>
<span class="sd">            REG     :</span>
<span class="sd">            _</span>
<span class="sd">            lbl:3 Dim = 15 |</span>
<span class="sd">            REG     :</span>

<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; z  = tor10.UniTensor(bonds=bds_x*2, rowrank=3, labels=[4,3,5,6,7,8])</span>
<span class="sd">            &gt;&gt;&gt; z2 = tor10.UniTensor(bonds=bds_x*2, rowrank=3, labels=[4,3,5,6,7,8])</span>
<span class="sd">            &gt;&gt;&gt; z.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 6</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 5         5 |____ 6  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 3 ____| 5         5 |____ 7  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 5 ____| 3         3 |____ 8  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        ------------- </span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; z.CombineBonds([4,5,6])</span>
<span class="sd">            &gt;&gt;&gt; z.Print_diagram()</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 225       5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           5 |____ 7  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           3 |____ 8  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------   </span>

<span class="sd">            &gt;&gt;&gt; z2.CombineBonds([4,5,6],permute_back=True)</span>
<span class="sd">            &gt;&gt;&gt; z2.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 225       5 |____ 7  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 3 ____| 5         3 |____ 8  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_to_combine</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CombineBonds&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] the number of bonds to combine should be greater than one.&quot;</span><span class="p">)</span>

        <span class="c1"># checking :</span>
        <span class="k">if</span> <span class="n">by_label</span><span class="p">:</span>
            <span class="n">same_lbls</span><span class="p">,</span> <span class="n">x_ind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">X_to_combine</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">same_lbls</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_to_combine</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] not all the label appears in the current tensor.&quot;</span><span class="p">)</span>

            <span class="n">idxs_to_combine</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">X_to_combine</span><span class="p">:</span>
                <span class="n">idxs_to_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">==</span> <span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">idxs_to_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idxs_to_combine</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="c1"># print(idxs_to_combine)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">X_to_combine</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] index out of bound&quot;</span><span class="p">)</span>

            <span class="n">idxs_to_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_to_combine</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="c1"># print(idxs_to_combine)</span>

        <span class="n">_CombineBonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs_to_combine</span><span class="p">,</span> <span class="n">new_label</span><span class="p">,</span> <span class="n">permute_back</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.Contiguous_"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Contiguous_">[docs]</a>    <span class="k">def</span> <span class="nf">Contiguous_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the memory to be contiguous. This is similar as pytorch&#39;s contiguous_().</span>
<span class="sd">        Because of the Permute does not move the memory, after permute, only the shape of UniTensor is changed, the underlying memory does not change. The UniTensor in this status is called &quot;non-contiguous&quot; tensor.</span>
<span class="sd">        When call the Contiguous_(), the memory will be moved to match the shape of UniTensor.</span>
<span class="sd">        *Note* Normally, it is not nessary to call contiguous. Most of the linalg function implicity will make the UniTensor contiguous. If one calls a function that requires a contiguous tensor, the error will be issue. Then you know you have to put UniTensor.Contiguous() or UniTensor.Contiguous_() there.</span>

<span class="sd">        Return:</span>
<span class="sd">            self</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(5),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            &gt;&gt;&gt; x = Tt.UniTensor(bonds=bds_x,rowrank=1, labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; print(x.is_contiguous())</span>
<span class="sd">            True</span>

<span class="sd">            &gt;&gt;&gt; x.Permute([0,2,1],rowrank=1)</span>
<span class="sd">            &gt;&gt;&gt; print(x.is_contiguous())</span>
<span class="sd">            False</span>

<span class="sd">            &gt;&gt;&gt; x.Contiguous_()</span>
<span class="sd">            &gt;&gt;&gt; print(x.is_contiguous())</span>
<span class="sd">            True</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1"># raise Exception(&quot;[Develope]&quot;)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Contiguous</span><span class="p">()</span>
                <span class="n">out</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.Contiguous"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Contiguous">[docs]</a>    <span class="k">def</span> <span class="nf">Contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the memory to be contiguous. This is similar as pytorch&#39;s contiguous().</span>
<span class="sd">        Because of the Permute does not move the memory, after permute, only the shape of UniTensor is changed, the underlying memory does not change. The UniTensor in this status is called &quot;non-contiguous&quot; tensor.</span>
<span class="sd">        When call the Contiguous(), the memory will be moved to match the shape of UniTensor.</span>
<span class="sd">        </span>
<span class="sd">        if the current tensor is already in contiguous, return self. Otherwise, return a new tensor.</span>


<span class="sd">        Return:</span>
<span class="sd">            self</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(5),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            &gt;&gt;&gt; x = Tt.UniTensor(bonds=bds_x,rowrank=1, labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; print(x.is_contiguous())</span>
<span class="sd">            True</span>

<span class="sd">            &gt;&gt;&gt; x.Permute([0,2,1],rowrank=1)</span>
<span class="sd">            &gt;&gt;&gt; print(x.is_contiguous())</span>
<span class="sd">            False</span>

<span class="sd">            &gt;&gt;&gt; y = x.Contiguous()</span>
<span class="sd">            &gt;&gt;&gt; print(y.is_contiguous())</span>
<span class="sd">            True</span>

<span class="sd">            &gt;&gt;&gt; print(x.is_contiguous())</span>
<span class="sd">            False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1"># raise Exception(&quot;[Develope]&quot;)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

                <span class="n">out</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">)</span>

                <span class="n">out_bd_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">out</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

                <span class="c1">## copy elemenets:  </span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="n">oldshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">oldshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">oldshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">oldidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
                            <span class="n">newidx</span> <span class="o">=</span> <span class="n">oldidx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">]</span>
                            <span class="c1">#</span>
                            <span class="n">new_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">_accu_off_in</span> <span class="o">*</span> <span class="n">newidx</span><span class="p">[:</span><span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]))</span>
                            <span class="n">new_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">_accu_off_out</span> <span class="o">*</span> <span class="n">newidx</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]))</span>
                            <span class="n">b_id_in</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">[</span><span class="n">new_row</span><span class="p">]</span>
                            <span class="n">b_id_out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span>

                            <span class="c1">## [DEBUG] &gt;&gt;&gt;&gt;</span>
                            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR][DEBUG][Internal check neg pos]&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ERROR!][DEBUG][Internal check un-matched block]&quot;</span><span class="p">)</span>
                                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="c1">## &lt;&lt;&lt;&lt;</span>
                            <span class="n">out</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">b_id_in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="c1"># out._contiguous = True</span>
                <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">is_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>
                <span class="k">return</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="UniTensor.is_contiguous"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.is_contiguous">[docs]</a>    <span class="k">def</span> <span class="nf">is_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the status of memory contiguous.</span>

<span class="sd">        Return:</span>
<span class="sd">            bool, if True, then the Storage of UniTensor is contiguous. if False, then the Storage of UiTensor is non-contiguous.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span></div>

<div class="viewcode-block" id="UniTensor.Permute"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Permute">[docs]</a>    <span class="k">def</span> <span class="nf">Permute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">by_label</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permute the bonds of the UniTensor.</span>
<span class="sd">            </span>
<span class="sd">            [Note] the computation complexity of Permute is O(1) which is very fast. The permute will not change the underlying memory layout. It will put the tensor into a &quot;non-contiguous&quot; status. Call Contiguous() or Contiguous_() when actually need to move memory.</span>


<span class="sd">        Args:</span>
<span class="sd">            mapper:</span>
<span class="sd">                a python list or 1d numpy array with integer type elements that the UniTensor permute accroding to. if by_label=False, the in_mapper will use index as mapper. </span>

<span class="sd">            by_label: [default False]</span>
<span class="sd">                bool, when True, the mapper using the labels. When False, the mapper using the index.</span>

<span class="sd">            rowrank: [default: current rowrank]</span>
<span class="sd">                uint, the rank of row space. If not set, it is equal to the current Tensor&#39;s rank of row space.</span>

<span class="sd">        Return:</span>

<span class="sd">            self</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(6),tor10.Bond(5),tor10.Bond(4),tor10.Bond(3),tor10.Bond(2)]</span>
<span class="sd">            &gt;&gt;&gt; x = tor10.UniTensor(bonds=bds_x, rowrank=3,labels=[1,3,5,7,8])</span>
<span class="sd">            &gt;&gt;&gt; y = copy.deepcopy(x)</span>
<span class="sd">            &gt;&gt;&gt; z = copy.deepcopy(x)</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 5</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 1 ____| 6         3 |____ 7  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 3 ____| 5         2 |____ 8  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 5 ____| 4           |        </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        ------------- </span>

<span class="sd">            &gt;&gt;&gt; x.Permute([0,2,1,4,3])</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 5</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 1 ____| 6         2 |____ 8  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 5 ____| 4         3 |____ 7  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 3 ____| 5           |        </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------</span>
<span class="sd"> </span>
<span class="sd">            &gt;&gt;&gt; y.Permute([3,1,5,7,8],by_label=True)</span>
<span class="sd">            &gt;&gt;&gt; y.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 5</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 3 ____| 5         3 |____ 7  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 1 ____| 6         2 |____ 8  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 5 ____| 4           |        </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------</span>

<span class="sd">            &gt;&gt;&gt; z.Permute([3,1,5,7,8],rowrank=2,by_label=True)</span>
<span class="sd">            &gt;&gt;&gt; z.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 5</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 3 ____| 5         4 |____ 5  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 1 ____| 6         3 |____ 7  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           2 |____ 8  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------</span>


<span class="sd"> </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## check</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Permute&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] mapper should be an 1d python list or numpy array.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Permute&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] len(mapper) should equal to Tensor rank&quot;</span><span class="p">)</span>

        <span class="c1">## check duplicate:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mapper</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Permute&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] mapper contain duplicate elements.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">by_label</span><span class="p">:</span>
            <span class="n">DD</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lbl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">mapper</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Permute&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;[ERROR] by_label=True but mapper contain invalid labels not appear in the UniTensor label&quot;</span><span class="p">)</span>
            <span class="n">idx_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">DD</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapper</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx_mapper</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idx_mapper</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">idx_mapper</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rowrank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rowrank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Permute&quot;</span><span class="p">,</span> <span class="s2">&quot;rowrank must &gt;=0&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="n">rowrank</span>

        <span class="c1">## check braket_form:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_braket</span><span class="p">()</span>

        <span class="c1">## master switch</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1"># raise Exception(&quot;[Developing]&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">[</span><span class="n">idx_mapper</span><span class="p">]</span>
            <span class="n">Arr_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">==</span> <span class="n">Arr_range</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">]</span> <span class="o">=</span> <span class="n">Arr_range</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

            <span class="n">b_tqin</span><span class="p">,</span> <span class="n">b_tqout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetTotalQnums</span><span class="p">(</span><span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">tqin_uni</span> <span class="o">=</span> <span class="n">b_tqin</span><span class="o">.</span><span class="n">GetUniqueQnums</span><span class="p">()</span>
            <span class="n">tqout_uni</span> <span class="o">=</span> <span class="n">b_tqout</span><span class="o">.</span><span class="n">GetUniqueQnums</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span> <span class="o">=</span> <span class="n">_fx_GetCommRows</span><span class="p">(</span><span class="n">tqin_uni</span><span class="p">,</span> <span class="n">tqout_uni</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Permute&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;[ERROR] UniTensor.is_diag=True must have rowrank==1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;Suggest, call Todense()&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(idx_mapper)</span>
                <span class="c1"># print(self.Storage)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idx_mapper</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.Reshape"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Reshape">[docs]</a>    <span class="k">def</span> <span class="nf">Reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimer</span><span class="p">,</span> <span class="n">rowrank</span><span class="p">,</span> <span class="n">new_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new reshaped UniTensor into the shape specified as [dimer], with the first [rowrank] Bonds as bra-bond and other bonds as ket-bond.</span>

<span class="sd">        [Note] </span>

<span class="sd">            1.Reshaping a UniTensor physically re-define the new basis, which construct a new physical definition tensor that has the same element.</span>

<span class="sd">            2.Reshape can only operate on an untagged tensor.</span>

<span class="sd">        Args:</span>

<span class="sd">            dimer:</span>
<span class="sd">                The new shape of the UniTensor. This should be a python list.</span>

<span class="sd">            rowrank:</span>
<span class="sd">                The number of bonds in row space.</span>

<span class="sd">            new_labels:</span>
<span class="sd">                The new labels that will be set for new bonds after reshape.</span>

<span class="sd">        reture:</span>

<span class="sd">            UniTensor</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(6),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            &gt;&gt;&gt; x = tor10.UniTensor(bonds=bds_x, rowrank=1,labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 6         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           3 |____ 5  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        ------------- </span>

<span class="sd">            &gt;&gt;&gt; y = x.Reshape([2,3,5,3],new_labels=[1,2,3,-1],rowrank=2)</span>
<span class="sd">            &gt;&gt;&gt; y.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 1 ____| 2         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 2 ____| 3         3 |____ -1 </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------  </span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] Cannot perform Reshape on a symmetry Tensor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] UniTensor.is_diag=True cannot be Reshape.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;[Suggest] Call UniTensor.Todense()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] UniTensor.Reshape can only operate on a [untagged] tensor with regular bonds (BD_REG).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimer</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] mapper should be an python list.&quot;</span><span class="p">)</span>

        <span class="n">new_Storage</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

        <span class="n">new_Storage</span> <span class="o">=</span> <span class="n">new_Storage</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dimer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bond</span><span class="p">(</span><span class="n">dimer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))]),</span>
                        <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                        <span class="n">rowrank</span><span class="o">=</span><span class="n">rowrank</span><span class="p">,</span>
                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">new_Storage</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="UniTensor.Reshape_"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.Reshape_">[docs]</a>    <span class="k">def</span> <span class="nf">Reshape_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimer</span><span class="p">,</span> <span class="n">rowrank</span><span class="p">,</span> <span class="n">new_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inplace version of Reshape. </span>
<span class="sd">        Reshape UniTensor into the shape specified as [dimer], with the first [rowrank] Bonds as bra-bond and other bonds as ket-bond.</span>

<span class="sd">        [Note] </span>

<span class="sd">            1.Reshapeing a UniTensor physically re-define the bra-ket basis space, which construct a new physical definition tensor that has the same element.</span>

<span class="sd">            2.Reshape can only operate on an untagged tensor.</span>

<span class="sd">        Args:</span>

<span class="sd">            dimer:</span>
<span class="sd">                The new shape of the UniTensor. This should be a python list.</span>

<span class="sd">            rowrank:</span>
<span class="sd">                The number of bonds in row space.</span>

<span class="sd">            new_labels [option]:</span>
<span class="sd">                The new labels that will be set for new bonds after reshape. If not set, the label will be initialize using default enumerate rule.</span>

<span class="sd">        Return:</span>

<span class="sd">            self</span>
<span class="sd">    </span>
<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(6),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            &gt;&gt;&gt; x = tor10.UniTensor(bonds=bds_x, rowrank=1,labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 6         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           3 |____ 5  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        ------------- </span>

<span class="sd">            &gt;&gt;&gt; x.Reshape_([2,3,5,3],new_labels=[1,2,3,-1],rowrank=2)</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 1 ____| 2         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 2 ____| 3         3 |____ -1 </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] Cannot perform Reshape on a symmetry Tensor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] UniTensor.is_diag=True cannot be Reshape.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;[Suggest] Call UniTensor.Todense()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] UniTensor.Reshape can only operate on a [untagged] tensor with regular bonds (BD_REG).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimer</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Reshape&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] mapper should be an python list.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dimer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">new_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bond</span><span class="p">(</span><span class="n">dimer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="n">rowrank</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UniTensor.View"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.View">[docs]</a>    <span class="k">def</span> <span class="nf">View</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimer</span><span class="p">,</span> <span class="n">rowrank</span><span class="p">,</span> <span class="n">new_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new view of UniTensor into the shape specified as [dimer], with the first [rowrank] Bonds as bra-bond and other bonds as ket-bond.</span>

<span class="sd">        The View() can only operate on a contiguous tensor, otherwise, Contiguous_() or Contiguous() need to be called before the tensor can be viewed. This is the same as pytorch.view().</span>

<span class="sd">        [Note] </span>

<span class="sd">            1.View a UniTensor physically re-define the new basis, which construct a new physical definition tensor that has the same element.</span>

<span class="sd">            2.View can only operate on an untagged tensor.</span>
<span class="sd">            </span>
<span class="sd">            3.View requires a contiguous tensor. </span>

<span class="sd">        Args:</span>

<span class="sd">            dimer:</span>
<span class="sd">                The new shape of the UniTensor. This should be a python list.</span>

<span class="sd">            rowrank:</span>
<span class="sd">                The number of bonds in row space.</span>

<span class="sd">            new_labels:</span>
<span class="sd">                The new labels that will be set for new bonds after reshape.</span>

<span class="sd">        reture:</span>

<span class="sd">            UniTensor</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(6),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            &gt;&gt;&gt; x = tor10.UniTensor(bonds=bds_x, rowrank=1,labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 6         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           3 |____ 5  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        ------------- </span>

<span class="sd">            &gt;&gt;&gt; x.Permute([0,2,1])</span>
<span class="sd">            &gt;&gt;&gt; x.Contiguous_() # this is needed. </span>
<span class="sd">            &gt;&gt;&gt; y = x.View([2,3,5,3],new_labels=[1,2,3,-1],rowrank=2)</span>
<span class="sd">            &gt;&gt;&gt; y.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 1 ____| 2         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 2 ____| 3         3 |____ -1 </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------  </span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.View&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] Cannot perform View on a symmetry Tensor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.View&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] UniTensor.is_diag=True cannot be View.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;[Suggest] Call UniTensor.Todense()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.View&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] UniTensor is not contiguous. Call Contiguous_() or Contiguous() before .View()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.View&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] UniTensor.View can only operate on a [untagged] tensor with regular bonds (BD_REG).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimer</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.View&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] mapper should be an python list.&quot;</span><span class="p">)</span>

        <span class="n">new_Storage</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>

        <span class="n">new_Storage</span> <span class="o">=</span> <span class="n">new_Storage</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dimer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bond</span><span class="p">(</span><span class="n">dimer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))]),</span>
                        <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                        <span class="n">rowrank</span><span class="o">=</span><span class="n">rowrank</span><span class="p">,</span>
                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">new_Storage</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="UniTensor.View_"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.View_">[docs]</a>    <span class="k">def</span> <span class="nf">View_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimer</span><span class="p">,</span> <span class="n">rowrank</span><span class="p">,</span> <span class="n">new_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inplace version of View. </span>
<span class="sd">        View UniTensor into the shape specified as [dimer], with the first [rowrank] Bonds as bra-bond and other bonds as ket-bond.</span>

<span class="sd">        The View_() can only operate on a contiguous tensor, otherwise, Contiguous_() or Contiguous() need to be called before the tensor can be viewed. This is the inplace version of pytorch.view().</span>
<span class="sd"> </span>

<span class="sd">        [Note] </span>

<span class="sd">            1.Viewing a UniTensor physically re-define the bra-ket basis space, which construct a new physical definition tensor that has the same element.</span>

<span class="sd">            2.Viewing can only operate on an untagged tensor.</span>

<span class="sd">            3. View_() requires a contiguous tensor.</span>

<span class="sd">        Args:</span>

<span class="sd">            dimer:</span>
<span class="sd">                The new shape of the UniTensor. This should be a python list.</span>

<span class="sd">            rowrank:</span>
<span class="sd">                The number of bonds in row space.</span>

<span class="sd">            new_labels [option]:</span>
<span class="sd">                The new labels that will be set for new bonds after reshape. If not set, the label will be initialize using default enumerate rule.</span>

<span class="sd">        Return:</span>

<span class="sd">            self</span>
<span class="sd">    </span>
<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; bds_x = [tor10.Bond(6),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            &gt;&gt;&gt; x = tor10.UniTensor(bonds=bds_x, rowrank=1,labels=[4,3,5])</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 4 ____| 6         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           3 |____ 5  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------</span>
<span class="sd"> </span>
<span class="sd">            &gt;&gt;&gt; x.Permute([0,2,1])</span>
<span class="sd">            &gt;&gt;&gt; x.Contiguous_() # this is needed</span>
<span class="sd">            &gt;&gt;&gt; x.Reshape_([2,3,5,3],new_labels=[1,2,3,-1],rowrank=2)</span>
<span class="sd">            &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 4</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 1 ____| 2         5 |____ 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 2 ____| 3         3 |____ -1 </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.View_()&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] Cannot perform View_ on a symmetry Tensor&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.View_()&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] UniTensor.is_diag=True cannot be View_.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;[Suggest] Call UniTensor.Todense()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.View_()&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;[ERROR] UniTensor.View_ can only operate on a [untagged] tensor with regular bonds (BD_REG).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimer</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.View_()&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] mapper should be an python list.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dimer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">new_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bond</span><span class="p">(</span><span class="n">dimer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimer</span><span class="p">))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="n">rowrank</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1">## Symmetric Tensor function</span>
<div class="viewcode-block" id="UniTensor.GetTotalQnums"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.GetTotalQnums">[docs]</a>    <span class="k">def</span> <span class="nf">GetTotalQnums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return two combined bond objects that has the information for the total qnums at bra and ket bonds.</span>

<span class="sd">        Args:</span>

<span class="sd">            physical [default: False]:</span>

<span class="sd">                Return the physical total qnums.</span>
<span class="sd">                </span>
<span class="sd">                If True, the return qnums_brabonds will be the physical qnums of all bonds tagged by BD_BRA, and qnums_ketbonds will be the physical qnums of all bonds tagged by BD_KET. </span>
<span class="sd">    </span>
<span class="sd">                If False, the return qnums will be the qnums of all bonds in row-space, the mismatch bond will have reversed qnums upon combined. This will match the layout of current blocks. </span>


<span class="sd">        Return:</span>
<span class="sd">            qnums_brabonds, qnums_ketbonds:</span>

<span class="sd">            qnums_brabonds:</span>
<span class="sd">                a tor10.Bond, the combined bra-bond</span>

<span class="sd">            qnums_ketbonds:</span>
<span class="sd">                a tor10.Bond, the combined ket-bond.</span>


<span class="sd">        Example:</span>

<span class="sd">            * Multiple Symmetry::</span>

<span class="sd">                ## multiple Qnum:</span>
<span class="sd">                ## U1 x U1 x U1 x U1</span>
<span class="sd">                ## U1 = {-2,-1,0,1,2}</span>
<span class="sd">                ## U1 = {-1,1}</span>
<span class="sd">                ## U1 = {0,1,2,3}</span>
<span class="sd">                bd_sym_1 = tor10.Bond(3,tor10.BD_KET,qnums=[[0, 2, 1, 0],</span>
<span class="sd">                                                            [1, 1,-1, 1],</span>
<span class="sd">                                                            [2,-1, 1, 0]])</span>
<span class="sd">                bd_sym_2 = tor10.Bond(4,tor10.BD_KET,qnums=[[-1, 0,-1, 3],</span>
<span class="sd">                                                            [ 0, 0,-1, 2],</span>
<span class="sd">                                                            [ 1, 0, 1, 0],</span>
<span class="sd">                                                            [ 2,-2,-1, 1]])</span>
<span class="sd">                bd_sym_3 = tor10.Bond(2,tor10.BD_BRA,qnums=[[-4, 3, 0,-1],</span>
<span class="sd">                                                            [ 1, 1, -2,3]])</span>

<span class="sd">                sym_T = tor10.UniTensor(bonds=[bd_sym_1,bd_sym_2,bd_sym_3],rowrank=2,labels=[1,2,3],dtype=torch.float64)</span>
<span class="sd">            &gt;&gt;&gt; sym_T.Pring_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: True</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            braket_form : True</span>
<span class="sd">                  |ket&gt;               &lt;bra| </span>
<span class="sd">                       ---------------      </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 1 &gt; __| 3         2 |__ &lt; 3  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 2 &gt; __| 4           |        </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       --------------- </span>

<span class="sd"> </span>
<span class="sd">            &gt;&gt;&gt; tqin, tqout = sym_T.GetTotalQnums()</span>
<span class="sd">            &gt;&gt;&gt; print(tqin)</span>
<span class="sd">            Dim = 12 |</span>
<span class="sd">            KET     : U1::  +4 +3 +2 +1 +3 +2 +1 +0 +2 +1 +0 -1</span>
<span class="sd">                      U1::  -3 -1 -1 -1 -1 +1 +1 +1 +0 +2 +2 +2</span>
<span class="sd">                      U1::  +0 +2 +0 +0 -2 +0 -2 -2 +0 +2 +0 +0</span>
<span class="sd">                      U1::  +1 +0 +2 +3 +2 +1 +3 +4 +1 +0 +2 +3</span>

<span class="sd">            &gt;&gt;&gt; print(tqout)</span>
<span class="sd">            Dim = 2 |</span>
<span class="sd">            BRA     : U1::  +1 -4</span>
<span class="sd">                      U1::  +1 +3</span>
<span class="sd">                      U1::  -2 +0</span>
<span class="sd">                      U1::  +3 -1</span>


<span class="sd">            &gt;&gt;&gt; sym_T.SetRowRank(1)</span>
<span class="sd">            &gt;&gt;&gt; sym_T.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: True</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            braket_form : False</span>
<span class="sd">                  |ket&gt;               &lt;bra| </span>
<span class="sd">                       ---------------      </span>
<span class="sd">                       |             |     </span>
<span class="sd">                 1 &gt; __| 3         4 |__*&gt; 2  </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       |           2 |__ &lt; 3  </span>
<span class="sd">                       |             |   </span>
<span class="sd">                       --------------- </span>

<span class="sd">            &gt;&gt;&gt; tqin2,tqout2 =  sym_T.GetTotalQnums()</span>
<span class="sd">            &gt;&gt;&gt; print(tqin2)</span>
<span class="sd">            Dim = 2 |</span>
<span class="sd">            KET     : U1::  -1 +1</span>
<span class="sd">                      U1::  -2 +1</span>
<span class="sd">                      U1::  -1 -2</span>
<span class="sd">                      U1::  +2 +3</span>

<span class="sd">            &gt;&gt;&gt; print(tqout2)</span>
<span class="sd">            Dim = 8 |</span>
<span class="sd">            BRA     : U1::  -1 -6 +0 -5 +1 -4 +2 -3</span>
<span class="sd">                      U1::  +3 +5 +1 +3 +1 +3 +1 +3</span>
<span class="sd">                      U1::  -1 +1 -3 -1 -1 +1 -1 +1</span>
<span class="sd">                      U1::  +2 -2 +3 -1 +1 -3 +0 -4</span>
<span class="sd"> </span>
<span class="sd">            &gt;&gt;&gt; tqin2_phy, tqout2_phy = sym_T.GetTotalQnums(physical=True)</span>
<span class="sd">            &gt;&gt;&gt; print(tqin2_phy)</span>
<span class="sd">            Dim = 12 |</span>
<span class="sd">            KET     : U1::  +4 +3 +2 +1 +3 +2 +1 +0 +2 +1 +0 -1</span>
<span class="sd">                      U1::  -3 -1 -1 -1 -1 +1 +1 +1 +0 +2 +2 +2</span>
<span class="sd">                      U1::  +0 +2 +0 +0 -2 +0 -2 -2 +0 +2 +0 +0</span>
<span class="sd">                      U1::  +1 +0 +2 +3 +2 +1 +3 +4 +1 +0 +2 +3</span>

<span class="sd">            &gt;&gt;&gt; print(tqout2_phy)</span>
<span class="sd">            Dim = 2 |</span>
<span class="sd">            BRA     : U1::  +1 -4</span>
<span class="sd">                      U1::  +1 +3</span>
<span class="sd">                      U1::  -2 +0</span>
<span class="sd">                      U1::  +3 -1</span>
<span class="sd">          </span>
<span class="sd">            &gt;&gt;&gt; print(tqin2 == tqin  ) ## this should be False</span>
<span class="sd">            False</span>

<span class="sd">            &gt;&gt;&gt; print(tqout2 == tqout) ## this should be False</span>
<span class="sd">            False</span>

<span class="sd">            &gt;&gt;&gt; print(tqin2_phy == tqin) ## this should be true</span>
<span class="sd">            True</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; print(tqout2_phy == tqout) ## this should be true</span>
<span class="sd">            True</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.GetTotalQnums&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] GetTotal Qnums from a non-symm tensor&quot;</span><span class="p">)</span>

        <span class="c1"># if (self.rowrank==0) or (self.rowrank==len(self.bonds)):</span>
        <span class="c1">#    raise Exception(&quot;UniTensor.GetTotalQnums&quot;,&quot;[ERROR] The TN symmetry structure is incorrect, without either any in-bond or any-outbond&quot;)</span>
        <span class="k">if</span> <span class="n">physical</span><span class="p">:</span>
            <span class="c1"># virtual_cb-in</span>
            <span class="n">cb_inbonds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
            <span class="n">in_all</span> <span class="o">=</span> <span class="n">cb_inbonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb_inbonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">in_all</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">cb_inbonds</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="n">cb_outbonds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span> <span class="o">==</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_BRA</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
            <span class="n">out_all</span> <span class="o">=</span> <span class="n">cb_outbonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb_outbonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out_all</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">cb_outbonds</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># virtual_cb-in</span>
            <span class="n">cb_inbonds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]</span> <span class="o">*</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_KET</span><span class="p">]</span>
            <span class="n">in_all</span> <span class="o">=</span> <span class="n">cb_inbonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb_inbonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">in_all</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">cb_inbonds</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">cb_outbonds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]</span> <span class="o">*</span> <span class="n">BondType</span><span class="p">[</span><span class="n">BD_BRA</span><span class="p">]</span>
            <span class="n">out_all</span> <span class="o">=</span> <span class="n">cb_outbonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb_outbonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out_all</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">cb_outbonds</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">in_all</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_KET</span>
        <span class="n">out_all</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">BD_BRA</span>

        <span class="k">return</span> <span class="n">in_all</span><span class="p">,</span> <span class="n">out_all</span></div>

<div class="viewcode-block" id="UniTensor.GetValidQnums"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.GetValidQnums">[docs]</a>    <span class="k">def</span> <span class="nf">GetValidQnums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the quatum number set that has a valid block.</span>

<span class="sd">            Args:</span>
<span class="sd">                </span>
<span class="sd">                physical [default: False]:</span>
<span class="sd">                    </span>
<span class="sd">                    if set to True, return the unique quantum number sets defined by BD_BRA and BD_KET.</span>

<span class="sd">                    The return 2D array has shape (# of blocks,qnum set)</span>

<span class="sd">                return_shape [default: False]:</span>
<span class="sd">            </span>
<span class="sd">                    if set to True, return a 2D array with shape (# of blocks, size of each block)</span>

<span class="sd">            Return </span>
<span class="sd">                </span>
<span class="sd">                if return_shape == False: return [qnum sets, 2D ndarray]  </span>
<span class="sd">                if return_shape == True : return [qnum sets, 2D ndarray], [shape (2D ndarray)]</span>
<span class="sd">                    </span>
<span class="sd">                    </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">physical</span><span class="p">:</span>
            <span class="n">b_tqin</span><span class="p">,</span> <span class="n">b_tqout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetTotalQnums</span><span class="p">(</span><span class="n">physical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tqin_uni</span> <span class="o">=</span> <span class="n">b_tqin</span><span class="o">.</span><span class="n">GetUniqueQnums</span><span class="p">()</span>
            <span class="n">tqout_uni</span> <span class="o">=</span> <span class="n">b_tqout</span><span class="o">.</span><span class="n">GetUniqueQnums</span><span class="p">()</span>
            <span class="n">comm</span> <span class="o">=</span> <span class="n">_fx_GetCommRows</span><span class="p">(</span><span class="n">tqin_uni</span><span class="p">,</span> <span class="n">tqout_uni</span><span class="p">)</span>
            <span class="n">shap</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">return_shape</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">:</span>
                    <span class="n">shap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b_tqin</span><span class="o">.</span><span class="n">GetDegeneracy</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">),</span> <span class="n">b_tqout</span><span class="o">.</span><span class="n">GetDegeneracy</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">)]))</span>
                <span class="k">return</span> <span class="n">comm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">comm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_shape</span><span class="p">:</span>
                <span class="n">b_tqin</span><span class="p">,</span> <span class="n">b_tqout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetTotalQnums</span><span class="p">(</span><span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">shap</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">:</span>
                    <span class="n">shap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b_tqin</span><span class="o">.</span><span class="n">GetDegeneracy</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">),</span> <span class="n">b_tqout</span><span class="o">.</span><span class="n">GetDegeneracy</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">)]))</span>
                <span class="k">return</span> <span class="n">comm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">comm</span></div>

<div class="viewcode-block" id="UniTensor.PutBlock"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.PutBlock">[docs]</a>    <span class="k">def</span> <span class="nf">PutBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">*</span><span class="n">qnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Put the block into the UniTensor. If the UniTensor is symmetry tensor, the block should be specify by the quantum number. </span>
<span class="sd">       </span>
<span class="sd">        Args:</span>
<span class="sd">            block:</span>
<span class="sd">                A UniTensor with rank-2</span>
<span class="sd">            </span>
<span class="sd">            *qnum:</span>
<span class="sd">                The quantum number set that specify the block.</span>

<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;[ERROR] PutBlock can only accept a untagged UniTensor &quot;</span><span class="p">)</span>

        <span class="c1">## Note, block should be a UniTensor:</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] PutBlock can only accept a untagged UniTensor &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1">## check:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;[ERROR] PutBlock for a is_diag=True tensor can only accept a block with is_diag=True&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">curr_shape_2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">numel</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">curr_shape_2d</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] the shape of input Block&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                    <span class="s2">&quot;does not match the shape of current block&quot;</span><span class="p">,</span> <span class="n">curr_shape_2d</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">curr_shape_2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">numel</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">curr_shape_2d</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] the shape of input Block&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                    <span class="s2">&quot;does not match the shape of current block&quot;</span><span class="p">,</span> <span class="n">curr_shape_2d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curr_shape_2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">dim</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]]),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">dim</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]])])</span>
                <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">curr_shape_2d</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] the shape of input Block&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                    <span class="s2">&quot;does not match the shape of current block&quot;</span><span class="p">,</span> <span class="n">curr_shape_2d</span><span class="p">)</span>

            <span class="c1">## memcpy low-lv-api</span>
            <span class="c1">#self.Storage.storage().copy_(block.Storage.storage())</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="c1"># raise Exception(&quot;[Warning] PutBlock cannot be use for non-symmetry TN. Use SetElem instead.&quot;)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># raise Exception(&quot;Developing&quot;)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nsym</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.PutBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] The qnumtum numbers not match the number of type.&quot;</span><span class="p">)</span>

            <span class="c1">## check contiguous:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">:</span>
                <span class="n">is_set</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1">## search if the tn has block of that qnums:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1">##check if shape is correct:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.PutBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] the input block with shape&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                            <span class="s2">&quot;does not match the current block&#39;s shape&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="c1">#self.Storage[s].storage().copy_(block.Storage.storage())</span>
                        <span class="n">shp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
                        <span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_set</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.PutBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] no block has qnums:&quot;</span><span class="p">,</span> <span class="n">qnum</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1">## search the current valid blocks :</span>
                <span class="n">is_set</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1">## get Nrowrank for the memory</span>
                        <span class="n">old_rowrank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                        <span class="n">accu_off</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                            <span class="n">accu_off</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                            <span class="n">tmp</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span>
                        <span class="n">accu_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accu_off</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                        <span class="n">new_accu_off_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu_off</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]</span> <span class="o">/</span> <span class="n">accu_off</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                        <span class="n">new_accu_off_out</span> <span class="o">=</span> <span class="n">accu_off</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]</span>
                        <span class="k">del</span> <span class="n">accu_off</span>

                        <span class="c1">## copy from the right address.</span>
                        <span class="n">b_tqin</span><span class="p">,</span> <span class="n">b_tqout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetTotalQnums</span><span class="p">(</span><span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">idx_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">b_tqin</span><span class="o">.</span><span class="n">qnums</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="n">idx_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">b_tqout</span><span class="o">.</span><span class="n">qnums</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

                        <span class="c1">## interface</span>
                        <span class="n">new_Ket_invmapper_blks</span> <span class="o">=</span> <span class="n">_fx_decompress_idx</span><span class="p">(</span><span class="n">idx_in</span><span class="p">,</span> <span class="n">new_accu_off_in</span><span class="p">)</span>
                        <span class="c1"># self._Ket_mapper_blks[idx_in,0] = b</span>
                        <span class="c1"># self._Ket_mapper_blks[idx_in,1] = np.arange(len(idx_in)).astype(np.int)</span>

                        <span class="c1">## interface</span>
                        <span class="n">new_Bra_invmapper_blks</span> <span class="o">=</span> <span class="n">_fx_decompress_idx</span><span class="p">(</span><span class="n">idx_out</span><span class="p">,</span> <span class="n">new_accu_off_out</span><span class="p">)</span>
                        <span class="c1"># self._Bra_mapper_blks[idx_out,0] = b</span>
                        <span class="c1"># self._Bra_mapper_blks[idx_out,1] = np.arange(len(idx_out)).astype(np.int)</span>

                        <span class="c1">## Get element only for this block from the right memory place:</span>
                        <span class="c1"># old_rowrank = self._Ket_invmapper_blks[0].</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_in</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_out</span><span class="p">)):</span>
                                <span class="n">newidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">new_Ket_invmapper_blks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_Bra_invmapper_blks</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                                <span class="n">oldidx</span> <span class="o">=</span> <span class="n">newidx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">]</span>

                                <span class="n">old_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span> <span class="o">*</span> <span class="n">oldidx</span><span class="p">[:</span><span class="n">old_rowrank</span><span class="p">]))</span>
                                <span class="n">old_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span> <span class="o">*</span> <span class="n">oldidx</span><span class="p">[</span><span class="n">old_rowrank</span><span class="p">:]))</span>

                                <span class="n">b_id_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">[</span><span class="n">old_row</span><span class="p">]</span>
                                <span class="n">b_id_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">[</span><span class="n">old_col</span><span class="p">]</span>

                                <span class="k">if</span> <span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] internal FATAL&quot;</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">b_id_in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[unphys pos]&quot;</span><span class="p">)</span>

                        <span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                        <span class="c1">## if there is no block with qnum:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_set</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.PutBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] No block has qnums:&quot;</span><span class="p">,</span> <span class="n">qnum</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.GetBlock"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.GetBlock">[docs]</a>    <span class="k">def</span> <span class="nf">GetBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">qnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Block specify by the quantum number(s). If the UniTensor is non-symmetry, return self.</span>

<span class="sd">        Args:</span>
<span class="sd">            *qnum:</span>
<span class="sd">                The quantum number(s). Note that when get-block on a High-rank tensor, the quantum number represent the total quantum number of all the in(out)-bonds.</span>

<span class="sd">        Return:</span>
<span class="sd">            * UniTensor, rank-2 (for symmetry tensor)</span>
<span class="sd">            * a new rank-2 flattened UniTensor (for non-symmetry tensor)</span>

<span class="sd">        Example:</span>
<span class="sd">            * Single Symmetry::</span>

<span class="sd">                bd_sym_1 = tor10.Bond(3,tor10.BD_KET,qnums=[[0],[1],[2]])</span>
<span class="sd">                bd_sym_2 = tor10.Bond(4,tor10.BD_KET,qnums=[[-1],[2],[0],[2]])</span>
<span class="sd">                bd_sym_3 = tor10.Bond(5,tor10.BD_BRA,qnums=[[4],[2],[2],[5],[1]])</span>
<span class="sd">                sym_T = tor10.UniTensor(bonds=[bd_sym_1,bd_sym_2,bd_sym_3],rowrank=2,labels=[10,11,12],dtype=torch.float64)</span>

<span class="sd">            &gt;&gt;&gt; sym_T.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 3</span>
<span class="sd">            has_symmetry: True</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            braket_form : True</span>
<span class="sd">                  |ket&gt;               &lt;bra| </span>
<span class="sd">                       ---------------      </span>
<span class="sd">                       |             |     </span>
<span class="sd">                10 &gt; __| 3         5 |__ &lt; 12 </span>
<span class="sd">                       |             |     </span>
<span class="sd">                11 &gt; __| 4           |        </span>
<span class="sd">                       |             |     </span>
<span class="sd">                       ---------------  </span>

<span class="sd">            &gt;&gt;&gt; q_in, q_out = sym_T.GetTotalQnums()</span>
<span class="sd">            &gt;&gt;&gt; print(q_in)</span>
<span class="sd">            Dim = 12 |</span>
<span class="sd">            KET     : U1::  +4 +4 +2 +1 +3 +3 +1 +0 +2 +2 +0 -1</span>

<span class="sd">            &gt;&gt;&gt; print(q_out)</span>
<span class="sd">            Dim = 5 |</span>
<span class="sd">            BRA     : U1::  +5 +4 +2 +2 +1</span>

<span class="sd">            &gt;&gt;&gt; bk2 = sym_T.GetBlock(2)</span>
<span class="sd">            &gt;&gt;&gt; bk2.Print_diagram()</span>
<span class="sd">            -----------------------</span>
<span class="sd">            tensor Name : </span>
<span class="sd">            tensor Rank : 2</span>
<span class="sd">            has_symmetry: False</span>
<span class="sd">            on device     : cpu</span>
<span class="sd">            is_diag       : False</span>
<span class="sd">                        -------------      </span>
<span class="sd">                       /             \     </span>
<span class="sd">                 0 ____| 3         2 |____ 1  </span>
<span class="sd">                       \             /     </span>
<span class="sd">                        -------------  </span>
<span class="sd"> </span>
<span class="sd">            &gt;&gt;&gt; print(bk2)</span>
<span class="sd">            Tensor name: </span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor([[0., 0.],</span>
<span class="sd">                    [0., 0.],</span>
<span class="sd">                    [0., 0.]], dtype=torch.float64)</span>

<span class="sd">            * Multiple Symmetry::</span>

<span class="sd">                ## multiple Qnum:</span>
<span class="sd">                ## U1 x U1 x U1 x U1</span>
<span class="sd">                bd_sym_1 = tor10.Bond(3,tor10.BD_KET,qnums=[[0, 2, 1, 0],</span>
<span class="sd">                                                            [1, 1,-1, 1],</span>
<span class="sd">                                                            [2,-1, 1, 0]])</span>
<span class="sd">                bd_sym_2 = tor10.Bond(4,tor10.BD_KET,qnums=[[-1, 0,-1, 3],</span>
<span class="sd">                                                            [ 0, 0,-1, 2],</span>
<span class="sd">                                                            [ 1, 0, 1, 0],</span>
<span class="sd">                                                            [ 2,-2,-1, 1]])</span>
<span class="sd">                bd_sym_3 = tor10.Bond(2,tor10.BD_BRA,qnums=[[-1,-2,-1,2],</span>
<span class="sd">                                                            [ 1, 1, -2,3]])</span>

<span class="sd">                sym_T = tor10.UniTensor(bonds=[bd_sym_1,bd_sym_2,bd_sym_3],rowrank=2,labels=[1,2,3],dtype=torch.float64)</span>

<span class="sd">            &gt;&gt;&gt; tqin, tqout = sym_T.GetTotalQnums()</span>
<span class="sd">            &gt;&gt;&gt; print(tqin)</span>
<span class="sd">            Dim = 12 |</span>
<span class="sd">            KET     : U1::  +4 +3 +2 +1 +3 +2 +1 +0 +2 +1 +0 -1</span>
<span class="sd">                      U1::  -3 -1 -1 -1 -1 +1 +1 +1 +0 +2 +2 +2</span>
<span class="sd">                      U1::  +0 +2 +0 +0 -2 +0 -2 -2 +0 +2 +0 +0</span>
<span class="sd">                      U1::  +1 +0 +2 +3 +2 +1 +3 +4 +1 +0 +2 +3</span>

<span class="sd">            &gt;&gt;&gt; print(tqout)</span>
<span class="sd">            Dim = 2 |</span>
<span class="sd">            BRA     : U1::  +1 -1</span>
<span class="sd">                      U1::  +1 -2</span>
<span class="sd">                      U1::  -2 -1</span>
<span class="sd">                      U1::  +3 +2</span>

<span class="sd">            &gt;&gt;&gt; block_1123 = sym_T.GetBlock(1,1,-2,3)</span>
<span class="sd">            &gt;&gt;&gt; print(block_1123)</span>
<span class="sd">            Tensor name: </span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor([[0.]], dtype=torch.float64)</span>




<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="n">bds</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span> <span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">)]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">bds</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_diag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="k">return</span> <span class="n">tmp</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bds</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">numel</span><span class="p">())]</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">bds</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                    <span class="k">return</span> <span class="n">tmp</span>

                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bds</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">numel</span><span class="p">())]</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">bds</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                    <span class="k">return</span> <span class="n">tmp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bds</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">dim</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]])),</span>
                           <span class="n">Bond</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">dim</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]]))]</span>

                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">bds</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">tmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># raise Exception(&quot;[Developing]&quot;)</span>

            <span class="c1"># if not self.is_braket:</span>
            <span class="c1">#    raise Exception(&quot;[ERROR] Can only get block from a symmetry Tensor in it&#39;s bra-ket form\n   Suggestion: call to_braket_form() or manually permute the tensor to the braket form. before get-block&quot;)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nsym</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UniTensor.GetBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] The qnumtum numbers not match the number of type.&quot;</span><span class="p">)</span>

            <span class="c1">## check contiguous:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">:</span>
                <span class="c1">## search if the tn has block of that qnums:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                        <span class="k">return</span> <span class="n">tmp</span>
                <span class="c1">## if there is no block with qnum:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.GetBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] No block has qnums:&quot;</span><span class="p">,</span> <span class="n">qnum</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## search the current valid blocks :</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1">## get Nrowrank for the memory</span>
                        <span class="n">old_rowrank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                        <span class="n">accu_off</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
                            <span class="n">accu_off</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                            <span class="n">tmp</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span>
                        <span class="n">accu_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accu_off</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                        <span class="n">new_accu_off_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu_off</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">]</span> <span class="o">/</span> <span class="n">accu_off</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                        <span class="n">new_accu_off_out</span> <span class="o">=</span> <span class="n">accu_off</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]</span>
                        <span class="k">del</span> <span class="n">accu_off</span>

                        <span class="c1">## copy from the right address.</span>
                        <span class="n">b_tqin</span><span class="p">,</span> <span class="n">b_tqout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetTotalQnums</span><span class="p">(</span><span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">idx_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">b_tqin</span><span class="o">.</span><span class="n">qnums</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="n">idx_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">b_tqout</span><span class="o">.</span><span class="n">qnums</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_qnums</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

                        <span class="c1">## Create only the block:</span>
                        <span class="n">Block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_in</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_out</span><span class="p">)),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

                        <span class="c1">## interface</span>
                        <span class="n">new_Ket_invmapper_blks</span> <span class="o">=</span> <span class="n">_fx_decompress_idx</span><span class="p">(</span><span class="n">idx_in</span><span class="p">,</span> <span class="n">new_accu_off_in</span><span class="p">)</span>
                        <span class="c1"># self._Ket_mapper_blks[idx_in,0] = b</span>
                        <span class="c1"># self._Ket_mapper_blks[idx_in,1] = np.arange(len(idx_in)).astype(np.int)</span>

                        <span class="c1">## interface</span>
                        <span class="n">new_Bra_invmapper_blks</span> <span class="o">=</span> <span class="n">_fx_decompress_idx</span><span class="p">(</span><span class="n">idx_out</span><span class="p">,</span> <span class="n">new_accu_off_out</span><span class="p">)</span>
                        <span class="c1"># self._Bra_mapper_blks[idx_out,0] = b</span>
                        <span class="c1"># self._Bra_mapper_blks[idx_out,1] = np.arange(len(idx_out)).astype(np.int)</span>

                        <span class="c1">## Get element only for this block from the right memory place:</span>
                        <span class="c1"># old_rowrank = self._Ket_invmapper_blks[0].</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_in</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_out</span><span class="p">)):</span>
                                <span class="n">newidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">new_Ket_invmapper_blks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_Bra_invmapper_blks</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                                <span class="n">oldidx</span> <span class="o">=</span> <span class="n">newidx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">]</span>

                                <span class="n">old_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span> <span class="o">*</span> <span class="n">oldidx</span><span class="p">[:</span><span class="n">old_rowrank</span><span class="p">]))</span>
                                <span class="n">old_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span> <span class="o">*</span> <span class="n">oldidx</span><span class="p">[</span><span class="n">old_rowrank</span><span class="p">:]))</span>

                                <span class="n">b_id_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">[</span><span class="n">old_row</span><span class="p">]</span>
                                <span class="n">b_id_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">[</span><span class="n">old_col</span><span class="p">]</span>

                                <span class="c1">## [DEBUG] &gt;&gt;&gt;</span>
                                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] internal FATAL&quot;</span><span class="p">)</span>
                                <span class="c1">## &lt;&lt;&lt;</span>

                                <span class="k">if</span> <span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">Block</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">b_id_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">b_id_in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b_id_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1">## [DEBUG] &gt;&gt;&gt;</span>
                                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ERROR] unphys pos!&quot;</span><span class="p">)</span>
                                    <span class="c1">## &lt;&lt;&lt;&lt;</span>

                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="n">Block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">Bond</span><span class="p">(</span><span class="n">Block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                                        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">rowrank</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">Block</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">tmp</span>
                <span class="c1">## if there is no block with qnum:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.GetBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] No block has qnums:&quot;</span><span class="p">,</span> <span class="n">qnum</span><span class="p">)</span></div>

<div class="viewcode-block" id="UniTensor.torch"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.torch">[docs]</a>    <span class="k">def</span> <span class="nf">torch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a UniTensor to torch.Tensor. </span>

<span class="sd">            [Note]</span>
<span class="sd">                </span>
<span class="sd">                1. this cannot be operate on a UniTensor with symmetry.</span>
<span class="sd">                2. the return tensor will not share the same memory with the UniTensor.</span>

<span class="sd">        Return:</span>
<span class="sd">            </span>
<span class="sd">            torch.Tensor</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR] cannot transform the UniTensor with symmetry to torch.Tensor. GetBlock first.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span></div>

    <span class="c1">## Autograd feature:</span>
<div class="viewcode-block" id="UniTensor.requires_grad"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.requires_grad">[docs]</a>    <span class="k">def</span> <span class="nf">requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_grad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The status for the autograd property.</span>

<span class="sd">        Args:</span>
<span class="sd">            is_grad:</span>
<span class="sd">                bool, if the autograd mechanism should be activate on this UniTensor.</span>
<span class="sd">                If the argument is not set, it will return the current autograd status.</span>

<span class="sd">        Return:</span>
<span class="sd">            bool, return only when is_grad argument is ignored.</span>

<span class="sd">        Example:</span>
<span class="sd">        ::</span>
<span class="sd">            bds_x = [tor10.Bond(5),tor10.Bond(5),tor10.Bond(3)]</span>
<span class="sd">            x = tor10.UniTensor(bonds=bds_x, rowrank=2, labels=[4,3,5])</span>


<span class="sd">        &gt;&gt;&gt; print(x.requires_grad())</span>
<span class="sd">        False</span>

<span class="sd">        &gt;&gt;&gt; x.requires_grad(True)</span>
<span class="sd">        &gt;&gt;&gt; print(x.requires_grad())</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; x.requires_grad(False)</span>
<span class="sd">        &gt;&gt;&gt; print(x.requires_grad())</span>
<span class="sd">        False</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">requires_grad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">is_grad</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">is_grad</span><span class="p">))</span></div>

<div class="viewcode-block" id="UniTensor.grad"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.grad">[docs]</a>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the gradient tensors subject to x where x is the current UniTensor. The return is None by default and becomes a UniTensor the first time a call backward(). The future calls to backward() will accumulate (add) gradient into it.</span>

<span class="sd">        This is the same as torch.Tensor.grad</span>


<span class="sd">        :math:`d/dx`</span>

<span class="sd">        Return:</span>
<span class="sd">            UniTensor, the shape of the return UniTensor and it&#39;s bonds are the same as the original UniTensor, but with default labels.</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; x = tor10.UniTensor(bonds=[tor10.Bond(2),tor10.Bond(2)],rowrank=1,requires_grad=True)</span>
<span class="sd">            &gt;&gt;&gt; print(x)</span>
<span class="sd">            Tensor name:</span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor([[0., 0.],</span>
<span class="sd">                    [0., 0.]], dtype=torch.float64, requires_grad=True)</span>

<span class="sd">            &gt;&gt;&gt; y = (x + 4)**2</span>
<span class="sd">            &gt;&gt;&gt; print(y)</span>
<span class="sd">            Tensor name:</span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor([[16., 16.],</span>
<span class="sd">                    [16., 16.]], dtype=torch.float64, grad_fn=&lt;PowBackward0&gt;)</span>

<span class="sd">            &gt;&gt;&gt; out = tor10.Mean(y)</span>
<span class="sd">            &gt;&gt;&gt; print(out)</span>
<span class="sd">            Tensor name:</span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor(16., dtype=torch.float64, grad_fn=&lt;MeanBackward1&gt;)</span>

<span class="sd">            &gt;&gt;&gt; out.backward()</span>
<span class="sd">            &gt;&gt;&gt; print(x.grad())</span>
<span class="sd">            Tensor name:</span>
<span class="sd">            is_diag    : False</span>
<span class="sd">            tensor([[2., 2.],</span>
<span class="sd">                    [2., 2.]], dtype=torch.float64)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">grad</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">))],</span>
                         <span class="n">braket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span>
                         <span class="n">sym_mappers</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mapper</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_mapper_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_contiguous</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">))</span>
                <span class="c1"># raise Exception(&quot;Developing&quot;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">),</span>
                                <span class="n">rowrank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="UniTensor.backward"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.backward">[docs]</a>    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backward the gradient flow in the contructed autograd graph. This is the same as torch.Tensor.backward</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span></div>

<div class="viewcode-block" id="UniTensor.detach"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.UniTensor.detach">[docs]</a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detach the current tensor from the current graph, making it a leaf. This is the same as torch.Tensor.detach_()</span>

<span class="sd">        Return:</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<span class="c1">###############################################################</span>
<span class="c1">#</span>
<span class="c1"># Action function</span>
<span class="c1">#</span>
<span class="c1">##############################################################</span>
<span class="c1">## I/O</span>
<div class="viewcode-block" id="Save"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.Save">[docs]</a><span class="k">def</span> <span class="nf">Save</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a UniTensor to the file</span>

<span class="sd">    Args:</span>
<span class="sd">        a:</span>
<span class="sd">            The UniTensor that to be saved.</span>

<span class="sd">        filename:</span>
<span class="sd">            The saved file path</span>

<span class="sd">    Example:</span>
<span class="sd">    ::</span>
<span class="sd">        a = tor10.UniTensor(bonds=[tor10.Bond(3),tor10.Bond(4)],rowrank=1)</span>
<span class="sd">        tor10.Save(a,&quot;a.uniT&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Save&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] Invalid filename.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">UniTensor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Save&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] input must be the UniTensor&quot;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Load"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.Load">[docs]</a><span class="k">def</span> <span class="nf">Load</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a UniTensor from the file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename:</span>
<span class="sd">            The path of the file to be loaded</span>

<span class="sd">    Return:</span>
<span class="sd">        UniTensor</span>

<span class="sd">    Example:</span>
<span class="sd">    ::</span>
<span class="sd">        a = tor10.Load(&quot;a.uniT&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;UniTensor.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] Invalid filename.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UniTensor.Load&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] file not exists&quot;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UniTensor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Load&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] loaded object is not the UniTensor&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tmp</span></div>


<div class="viewcode-block" id="Contract"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.Contract">[docs]</a><span class="k">def</span> <span class="nf">Contract</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Contract two tensors with the same labels.</span>

<span class="sd">        1. two tensors must be the same type, if &quot;a&quot; is a symmetry/untagged/tagged tensor, &quot;b&quot; must also be a symmetry/untagged/tagged tensor.</span>
<span class="sd">        2. When contract two symmetry tensor, the bonds that to be contracted must have the same qnums.</span>

<span class="sd">        3. For tagged tensor, Each bra-bond can only contract with ket-bond, in terms of physical meaning, this means the contract traceing out the matched bra-ket.</span>

<span class="sd">        [Note] the argument &quot;a&quot; and &quot;b&quot; tensor defines the order of the out-come bond. After contract,  the order of remaining bonds (both in-bond(bra) and out-bond(ket)) that appears in the new-tensor will follows the rule: a&#39;s in-bond will appears first, then the b&#39;s in-bond; a&#39;s out-bond will appears first, then b&#39;s out-bond (see example in below)</span>


<span class="sd">        Args:</span>
<span class="sd">            a:</span>
<span class="sd">                UniTensor</span>

<span class="sd">            b:</span>
<span class="sd">                UniTensor</span>


<span class="sd">        Return:</span>
<span class="sd">            UniTensor</span>

<span class="sd">        Example:</span>
<span class="sd">        ::</span>
<span class="sd">            x = tor10.UniTensor(bonds=[tor10.Bond(5),tor10.Bond(2),tor10.Bond(4),tor10.Bond(3)], rowrank=2,labels=[6,1,7,8])</span>
<span class="sd">            y = tor10.UniTensor(bonds=[tor10.Bond(4),tor10.Bond(2),tor10.Bond(3),tor10.Bond(6)], rowrank=2,labels=[7,2,10,9])</span>


<span class="sd">        &gt;&gt;&gt; x.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 4</span>
<span class="sd">        has_symmetry: False</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        is_diag       : False</span>
<span class="sd">                    -------------      </span>
<span class="sd">                   /             \     </span>
<span class="sd">             6 ____| 5         4 |____ 7  </span>
<span class="sd">                   |             |     </span>
<span class="sd">             1 ____| 2         3 |____ 8  </span>
<span class="sd">                   \             /     </span>
<span class="sd">                    -------------   </span>

<span class="sd">        &gt;&gt;&gt; y.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 4</span>
<span class="sd">        has_symmetry: False</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        is_diag       : False</span>
<span class="sd">                    -------------      </span>
<span class="sd">                   /             \     </span>
<span class="sd">             7 ____| 4         3 |____ 10 </span>
<span class="sd">                   |             |     </span>
<span class="sd">             2 ____| 2         6 |____ 9  </span>
<span class="sd">                   \             /     </span>
<span class="sd">                    -------------  </span>

<span class="sd">        &gt;&gt;&gt; c = tor10.Contract(x,y)</span>
<span class="sd">        &gt;&gt;&gt; c.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 6</span>
<span class="sd">        has_symmetry: False</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        is_diag       : False</span>
<span class="sd">                    -------------      </span>
<span class="sd">                   /             \     </span>
<span class="sd">             6 ____| 5         3 |____ 8  </span>
<span class="sd">                   |             |     </span>
<span class="sd">             1 ____| 2         3 |____ 10 </span>
<span class="sd">                   |             |     </span>
<span class="sd">             2 ____| 2         6 |____ 9  </span>
<span class="sd">                   \             /     </span>
<span class="sd">                    -------------  </span>

<span class="sd">        &gt;&gt;&gt; d = tor10.Contract(y,x)</span>
<span class="sd">        &gt;&gt;&gt; d.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 6</span>
<span class="sd">        has_symmetry: False</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        is_diag       : False</span>
<span class="sd">                    -------------      </span>
<span class="sd">                   /             \     </span>
<span class="sd">             2 ____| 2         3 |____ 10 </span>
<span class="sd">                   |             |     </span>
<span class="sd">             6 ____| 5         6 |____ 9  </span>
<span class="sd">                   |             |     </span>
<span class="sd">             1 ____| 2         3 |____ 8  </span>
<span class="sd">                   \             /     </span>
<span class="sd">                    -------------  </span>


<span class="sd">        Note that you can also contract for UniTensor with symmetry, even when they are not in the bra-ket form. As long as the quantum number on the to-be-contract bonds and the bond type matches (bra can only contract with ket)</span>
<span class="sd">        ::</span>
<span class="sd">            bd_sym_1a = tor10.Bond(3,tor10.BD_KET,qnums=[[0],[1],[2]])</span>
<span class="sd">            bd_sym_2a = tor10.Bond(4,tor10.BD_KET,qnums=[[-1],[2],[0],[2]])</span>
<span class="sd">            bd_sym_3a = tor10.Bond(5,tor10.BD_BRA,qnums=[[4],[2],[-1],[5],[1]])</span>

<span class="sd">            bd_sym_1b = tor10.Bond(3,tor10.BD_BRA,qnums=[[0],[1],[2]])</span>
<span class="sd">            bd_sym_2b = tor10.Bond(4,tor10.BD_BRA,qnums=[[-1],[2],[0],[2]])</span>
<span class="sd">            bd_sym_3b = tor10.Bond(7,tor10.BD_KET,qnums=[[1],[3],[-2],[2],[2],[2],[0]])</span>

<span class="sd">            sym_A = tor10.UniTensor(bonds=[bd_sym_1a,bd_sym_2a,bd_sym_3a],rowrank=2,labels=[10,11,12])</span>
<span class="sd">            sym_B = tor10.UniTensor(bonds=[bd_sym_2b,bd_sym_1b,bd_sym_3b],rowrank=1,labels=[11,10,7])</span>


<span class="sd">        &gt;&gt;&gt; sym_A.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 3</span>
<span class="sd">        has_symmetry: True</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        braket_form : True</span>
<span class="sd">              |ket&gt;               &lt;bra| </span>
<span class="sd">                   ---------------      </span>
<span class="sd">                   |             |     </span>
<span class="sd">            10 &gt; __| 3         5 |__ &lt; 12 </span>
<span class="sd">                   |             |     </span>
<span class="sd">            11 &gt; __| 4           |        </span>
<span class="sd">                   |             |     </span>
<span class="sd">                   ---------------  </span>


<span class="sd">        &gt;&gt;&gt; sym_B.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 3</span>
<span class="sd">        has_symmetry: True</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        braket_form : False</span>
<span class="sd">              |ket&gt;               &lt;bra| </span>
<span class="sd">                   ---------------      </span>
<span class="sd">                   |             |     </span>
<span class="sd">            11 &lt;*__| 4         3 |__ &lt; 10 </span>
<span class="sd">                   |             |     </span>
<span class="sd">                   |           7 |__*&gt; 7  </span>
<span class="sd">                   |             |     </span>
<span class="sd">                   ---------------  </span>

<span class="sd">        &gt;&gt;&gt; sym_AB = tor10.Contract(sym_A,sym_B)</span>
<span class="sd">        &gt;&gt;&gt; sym_BA = tor10.Contract(sym_B,sym_A)</span>
<span class="sd">        &gt;&gt;&gt; sym_AB.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 2</span>
<span class="sd">        has_symmetry: True</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        braket_form : False</span>
<span class="sd">              |ket&gt;               &lt;bra| </span>
<span class="sd">                   ---------------      </span>
<span class="sd">                   |             |     </span>
<span class="sd">            12 &lt;*__| 5         7 |__*&gt; 7  </span>
<span class="sd">                   |             |     </span>
<span class="sd">                   ---------------  </span>
<span class="sd">     </span>
<span class="sd">        &gt;&gt;&gt; sym_BA.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 2</span>
<span class="sd">        has_symmetry: True</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        braket_form : True</span>
<span class="sd">              |ket&gt;               &lt;bra| </span>
<span class="sd">                   ---------------      </span>
<span class="sd">                   |             |     </span>
<span class="sd">             7 &gt; __| 7         5 |__ &lt; 12 </span>
<span class="sd">                   |             |     </span>
<span class="sd">                   --------------- </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">UniTensor</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">UniTensor</span><span class="p">):</span>

        <span class="c1">## check:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">is_symm</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">is_symm</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Contract(a,b)&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] the tensors should be the same type to be contracted&quot;</span><span class="p">)</span>

        <span class="c1">## get same vector:</span>
        <span class="n">same</span><span class="p">,</span> <span class="n">a_ind</span><span class="p">,</span> <span class="n">b_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">aind_no_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span> <span class="n">a_ind</span><span class="p">)</span>
        <span class="n">bind_no_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span> <span class="n">b_ind</span><span class="p">)</span>

        <span class="c1">## master switch</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1">## contract symm tensor &gt; </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">same</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_ind</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">a_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">qnums</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">b_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">qnums</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Contact(a,b)&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] contract Bonds that has qnums mismatch.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">a_ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">b_ind</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Contract(a,b)&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] bra-bond can only contract with ket-bond&quot;</span><span class="p">)</span>

                <span class="n">tmpa</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="n">tmpb</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">tmpa</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aind_no_combine</span><span class="p">,</span> <span class="n">a_ind</span><span class="p">),</span> <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_ind</span><span class="p">),</span>
                             <span class="n">by_label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">Contiguous_</span><span class="p">()</span>
                <span class="n">tmpb</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">bind_no_combine</span><span class="p">),</span> <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">b_ind</span><span class="p">),</span> <span class="n">by_label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">Contiguous_</span><span class="p">()</span>

                <span class="c1"># tmpa.Print_diagram()</span>
                <span class="c1"># print(tmpa)</span>
                <span class="c1"># print(tmpa.GetValidQnums(return_shape=True))</span>
                <span class="c1"># tmpb.Print_diagram()</span>
                <span class="c1"># print(tmpb)</span>
                <span class="c1"># print(tmpb.GetValidQnums(return_shape=True))</span>
                <span class="c1"># tmpa._Bra_mapper_blks</span>

                <span class="n">aQ</span> <span class="o">=</span> <span class="n">tmpa</span><span class="o">.</span><span class="n">GetValidQnums</span><span class="p">()</span>
                <span class="n">bQ</span> <span class="o">=</span> <span class="n">tmpb</span><span class="o">.</span><span class="n">GetValidQnums</span><span class="p">()</span>

                <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpa</span><span class="o">.</span><span class="n">bonds</span><span class="p">[:</span><span class="n">tmpa</span><span class="o">.</span><span class="n">rowrank</span><span class="p">],</span> <span class="n">tmpb</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">tmpb</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]),</span>
                                <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpa</span><span class="o">.</span><span class="n">labels</span><span class="p">[:</span><span class="n">tmpa</span><span class="o">.</span><span class="n">rowrank</span><span class="p">],</span> <span class="n">tmpb</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">tmpb</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:]),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                <span class="n">device</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                <span class="n">oQ</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">GetValidQnums</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">obid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oQ</span><span class="p">)):</span>
                    <span class="n">ab</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">abid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aQ</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">oQ</span><span class="p">[</span><span class="n">obid</span><span class="p">]</span> <span class="o">==</span> <span class="n">aQ</span><span class="p">[</span><span class="n">abid</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">ab</span> <span class="o">=</span> <span class="n">abid</span>
                            <span class="k">break</span>

                    <span class="n">bb</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">bbid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bQ</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">oQ</span><span class="p">[</span><span class="n">obid</span><span class="p">]</span> <span class="o">==</span> <span class="n">bQ</span><span class="p">[</span><span class="n">bbid</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">bb</span> <span class="o">=</span> <span class="n">bbid</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">ab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">obid</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tmpa</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">ab</span><span class="p">],</span> <span class="n">tmpb</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>

                <span class="k">return</span> <span class="n">out</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## product!!</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Developing&quot;</span><span class="p">)</span>




        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## contract non-sym tensor &gt; </span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">same</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>

                    <span class="n">tmpa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmpa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span>

                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="n">tmpb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmpb</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">Storage</span>

                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">## contract untagged </span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">tmpa</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">a_ind</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">b_ind</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

                    <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">aind_no_combine</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bind_no_combine</span><span class="p">])])</span>
                    <span class="n">new_io</span> <span class="o">=</span> <span class="p">[(</span><span class="n">aind_no_combine</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aind_no_combine</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">bind_no_combine</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bind_no_combine</span><span class="p">))]</span>
                    <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">aind_no_combine</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">bind_no_combine</span><span class="p">])])</span>

                    <span class="n">new_io</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                    <span class="c1"># print(new_io)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                        <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">new_bonds</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">*</span><span class="n">mapper</span><span class="p">)</span>

                    <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">new_bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">new_io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)),</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">out</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## tagged</span>
                    <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">a_ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">b_ind</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Contract(a,b)&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] in-bond(bra) can only contract with out-bond (ket)&quot;</span><span class="p">)</span>

                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">tmpa</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">a_ind</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">b_ind</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

                    <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">aind_no_combine</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bind_no_combine</span><span class="p">])])</span>
                    <span class="n">new_io</span> <span class="o">=</span> <span class="p">[(</span><span class="n">aind_no_combine</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aind_no_combine</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">bind_no_combine</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bind_no_combine</span><span class="p">))]</span>
                    <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">aind_no_combine</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">bind_no_combine</span><span class="p">])])</span>
                    <span class="n">new_braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">aind_no_combine</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">bind_no_combine</span><span class="p">])])</span>

                    <span class="n">new_io</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                    <span class="c1"># print(new_io)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                        <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">new_bonds</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">new_braket</span> <span class="o">=</span> <span class="n">new_braket</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">*</span><span class="n">mapper</span><span class="p">)</span>

                    <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">new_bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">new_io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)),</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="n">new_braket</span><span class="p">,</span> <span class="n">torch_tensor</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## product!!</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="n">tmpa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmpa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span>

                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                    <span class="n">tmpb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmpb</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">Storage</span>

                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">## untagged </span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">tmpa</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">)])</span>
                    <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">)])</span>
                    <span class="n">new_io</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                                                                <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">))]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                        <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">new_bonds</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">*</span><span class="n">mapper</span><span class="p">)</span>

                    <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">new_bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">out</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## tagged</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">tmpa</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">)])</span>
                    <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">)])</span>
                    <span class="n">new_braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">braket</span><span class="p">)])</span>
                    <span class="n">new_io</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                                                                <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">))]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                        <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">new_bonds</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">new_braket</span> <span class="o">=</span> <span class="n">new_braket</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">*</span><span class="n">mapper</span><span class="p">)</span>

                    <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">new_bonds</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                                    <span class="n">rowrank</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">braket</span><span class="o">=</span><span class="n">new_braket</span><span class="p">,</span>
                             <span class="n">torch_tensor</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">out</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">same</span><span class="p">):</span>

            <span class="c1"># if(a.is_symm):</span>
            <span class="c1">#    for i in range(len(a_ind)):</span>
            <span class="c1">#        if not a.bonds[a_ind[i]].qnums.all() == b.bonds[b_ind[i]].qnums.all():</span>
            <span class="c1">#            raise ValueError(&quot;Contact(a,b)&quot;,&quot;[ERROR] contract Bonds that has qnums mismatch.&quot;)</span>

            <span class="c1">## check bra-ket</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">a_ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">b_ind</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Contract(a,b)&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] in-bond(bra) can only contract with out-bond (ket)&quot;</span><span class="p">)</span>

            <span class="n">aind_no_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span> <span class="n">a_ind</span><span class="p">)</span>
            <span class="n">bind_no_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span> <span class="n">b_ind</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="n">tmpa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span>

            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="n">tmpb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpb</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">Storage</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">tmpa</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">a_ind</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">b_ind</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

            <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">aind_no_combine</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bind_no_combine</span><span class="p">])])</span>
            <span class="n">new_io</span> <span class="o">=</span> <span class="p">[(</span><span class="n">aind_no_combine</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aind_no_combine</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">bind_no_combine</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bind_no_combine</span><span class="p">))]</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">aind_no_combine</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">bind_no_combine</span><span class="p">])])</span>

            <span class="n">new_io</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
            <span class="c1"># print(new_io)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">new_bonds</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                <span class="n">new_labels</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">*</span><span class="n">mapper</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">new_bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">new_io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)),</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## direct product</span>

            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="n">tmpa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span>

            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="n">tmpb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpb</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">Storage</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">tmpa</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">)])</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">labels</span><span class="p">)])</span>
            <span class="n">new_io</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">bonds</span><span class="p">))]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">new_io</span><span class="p">)</span>
                <span class="n">new_bonds</span> <span class="o">=</span> <span class="n">new_bonds</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                <span class="n">new_labels</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">*</span><span class="n">mapper</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">new_bonds</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">,</span>
                            <span class="n">rowrank</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">rowrank</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Contract(a,b)&#39;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] a and b both have to be UniTensor&quot;</span><span class="p">)</span></div>


<span class="c1">## The functions that start with &quot;_&quot; are the private functions</span>

<span class="k">def</span> <span class="nf">_CombineBonds</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">new_label</span><span class="p">,</span> <span class="n">permute_back</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    [Private function, should not be called directly by user]</span>

<span class="sd">    This function combines the bonds in input UniTensor [a] by the specified labels [label]. The bondType of the combined bonds will always follows the same bondType of bond in [a] with label of the largest index element in [label]</span>

<span class="sd">    Args:</span>

<span class="sd">        a:</span>
<span class="sd">            UniTensor</span>

<span class="sd">        idxs:</span>

<span class="sd">            index that to be combined. It should be a int list / numpy array of the label. All the bonds with specified labels in the current UniTensor  will be combined</span>

<span class="sd">        new_label:</span>
<span class="sd">            the new_label of the combined bond </span>

<span class="sd">        permute_back:</span>
<span class="sd">            Set if the current bond should be permute back</span>

<span class="sd">            </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">UniTensor</span><span class="p">):</span>

        <span class="n">idx_no_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span>
                                      <span class="n">idxs</span><span class="p">)</span>  <span class="c1">## idx_no_combine will be from small to large, sorted!</span>
        <span class="n">old_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">combined_dim</span> <span class="o">=</span> <span class="n">old_shape</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
        <span class="n">combined_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">combined_dim</span><span class="p">)</span>
        <span class="n">no_combine_dims</span> <span class="o">=</span> <span class="n">old_shape</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">]</span>

        <span class="c1">## Set new label if appears.</span>
        <span class="k">if</span> <span class="n">new_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newlbl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newlbl</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">]</span> <span class="ow">or</span> <span class="n">newlbl</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;_CombineBonds&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;[ERROR], cannot set new_label to </span><span class="si">%d</span><span class="s2"> as there will be duplicate bond with this label after combined&quot;</span> <span class="o">%</span> <span class="n">newlbl</span><span class="p">)</span>

            <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">newlbl</span>

        <span class="c1">##------------------------------------</span>
        <span class="c1">## master switch </span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="c1">## symmetry</span>
            <span class="c1"># raise Exception(&quot;[Develope]&quot;)</span>

            <span class="c1">## check if the combine are BRA or KET</span>
            <span class="n">contype_inout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">idxs</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contype_inout</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;_CombineBonds&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;[ERROR], label_to_combine should be all bra-bond or all ket-bond for Tensor with symmetry&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">idxs</span><span class="p">,</span> <span class="n">idx_no_combine</span><span class="p">)),</span> <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">),</span> <span class="n">by_label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">## put it on the contiguous form:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Contiguous_</span><span class="p">()</span>

                <span class="c1">## DEBUG &gt;&gt;&gt;</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR][DEBUG][internal] non-contiguous!!&quot;</span><span class="p">)</span>
                <span class="c1">## &lt;&lt;&lt;</span>

                <span class="c1">##[Fusion tree] &gt;&gt;&gt;</span>
                <span class="c1"># new_Nin = a.rowrank</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># if idxs[1+i]&lt;a.rowrank:</span>
                    <span class="c1">#    new_Nin-=1</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
                <span class="c1">## &lt;&lt;&lt;</span>

                <span class="n">del_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">del_pos</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span> <span class="n">del_pos</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">del_pos</span><span class="p">)</span>

                <span class="c1">##house keeping mappers </span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">_Ket_invmapper_blks</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">_accu_off_in</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">a</span><span class="o">.</span><span class="n">_accu_off_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> <span class="n">dype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>  <span class="c1">## contiguous, so we just init</span>
                <span class="n">a</span><span class="o">.</span><span class="n">_inv_mapper</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">_mapper</span><span class="p">)</span>

                <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Permute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">idx_no_combine</span><span class="p">,</span> <span class="n">idxs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="n">rowrank</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">),</span>
                          <span class="n">by_label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">## put it on the contiguous form:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Contiguous_</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
                <span class="c1">## DEBUG &gt;&gt;&gt;</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[ERROR][DEBUG][internal] non-contiguous!!&quot;</span><span class="p">)</span>
                <span class="c1">## &lt;&lt;&lt;</span>

                <span class="c1">##[Fusion tree] &gt;&gt;&gt;</span>
                <span class="c1"># new_Nin = a.rowrank</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># if idxs[1+i]&lt;a.rowrank:</span>
                    <span class="c1">#    new_Nin-=1</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="p">])</span>
                <span class="c1">## &lt;&lt;&lt;</span>

                <span class="n">del_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">del_pos</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">del_pos</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span> <span class="n">del_pos</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">del_pos</span><span class="p">)</span>

                <span class="c1">##house keeping mappers </span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">_Bra_invmapper_blks</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">_accu_off_out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">a</span><span class="o">.</span><span class="n">_accu_off_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>  <span class="c1">## contiguous, so we just init</span>
                <span class="n">a</span><span class="o">.</span><span class="n">_inv_mapper</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">_mapper</span><span class="p">)</span>

                <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">permute_back</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">braket_form</span><span class="p">()</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## non-symm</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_diag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;_CombineBonds&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] CombineBonds doesn&#39;t support diagonal matrix.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">## untagged type:</span>

                <span class="k">if</span> <span class="n">permute_back</span><span class="p">:</span>

                    <span class="c1">##[Fusion tree] &gt;&gt;&gt;</span>
                    <span class="n">new_Nin</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:</span>
                            <span class="n">new_Nin</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]])</span>
                    <span class="c1">## &lt;&lt;&lt;</span>

                    <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">idxs</span><span class="p">,</span> <span class="n">idx_no_combine</span><span class="p">])</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_dim</span><span class="p">,</span> <span class="n">no_combine_dims</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="n">f_label</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">==</span> <span class="n">f_label</span><span class="p">)</span>
                    <span class="n">final_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">Stoarge</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">final_mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="n">new_Nin</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">##[Fusion tree] &gt;&gt;&gt;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]])</span>
                    <span class="c1">## &lt;&lt;&lt;</span>
                    <span class="k">if</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">idx_no_combine</span><span class="p">,</span> <span class="n">idxs</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">],</span> <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">],</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">no_combine_dims</span><span class="p">,</span> <span class="n">combined_dim</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">idxs</span><span class="p">,</span> <span class="n">idx_no_combine</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_dim</span><span class="p">,</span> <span class="n">no_combine_dims</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1">## if the combine are BRA or KET</span>
                <span class="n">contype_inout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">idxs</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contype_inout</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;_CombineBonds&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;[ERROR], label_to_combine should be all bra-bond or all ket-bond for tagged-nonsymm Tensor&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">permute_back</span><span class="p">:</span>

                    <span class="c1">##[Fusion tree] &gt;&gt;&gt;</span>
                    <span class="n">new_Nin</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span>
                    <span class="c1"># print(a.bonds)</span>
                    <span class="c1"># print(a.bonds.shape)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:</span>
                            <span class="n">new_Nin</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]])</span>
                    <span class="c1">## &lt;&lt;&lt;</span>

                    <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">idxs</span><span class="p">,</span> <span class="n">idx_no_combine</span><span class="p">])</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_dim</span><span class="p">,</span> <span class="n">no_combine_dims</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="n">f_label</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">,</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">==</span> <span class="n">f_label</span><span class="p">)</span>
                    <span class="n">final_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">Stoarge</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">final_mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="n">new_Nin</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c1">##[Fusion tree] &gt;&gt;&gt;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]])</span>
                    <span class="c1">## &lt;&lt;&lt;</span>
                    
                    <span class="k">if</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">idx_no_combine</span><span class="p">,</span> <span class="n">idxs</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">],</span> <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">],</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">],</span> <span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">no_combined_dims</span><span class="p">,</span> <span class="n">combine_dim</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                       
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">idxs</span><span class="p">,</span> <span class="n">idx_no_combine</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">a</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">braket</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">a</span><span class="o">.</span><span class="n">braket</span><span class="p">[</span><span class="n">idx_no_combine</span><span class="p">])</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_dim</span><span class="p">,</span> <span class="n">no_combine_dims</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">rowrank</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;_CombineBonds(UniTensor,int_arr)&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] )CombineBonds can only accept UniTensor&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_Randomize</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @description: &lt;private function&gt; This function randomize a UniTensor.</span>
<span class="sd">        @params     :</span>
<span class="sd">                      a : UniTensor</span>
<span class="sd">        @return     : N/A</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">UniTensor</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_symm</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">Storage</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;_Randomize(UniTensor)&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] _Randomize can only accept UniTensor&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="From_torch"><a class="viewcode-back" href="../../UniTensor.html#tor10.UniTensor.From_torch">[docs]</a><span class="k">def</span> <span class="nf">From_torch</span><span class="p">(</span><span class="n">torch_tensor</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct UniTensor from torch.Tensor.</span>

<span class="sd">    If the input torch_tensor belongs to a autograd graph, the contructed UniTensor will preserve the role of the input torch_tensor in the computational graph.</span>

<span class="sd">    Args:</span>
<span class="sd">        torch_tensor:</span>
<span class="sd">            Torch.Tensor</span>

<span class="sd">        rowrank:</span>
<span class="sd">            int, The number of inbond. Note that the first [rowrank] bonds will be set to tor10.BD_IN, and the remaining bonds will be set to tor10.BD_OUT</span>

<span class="sd">        labels:</span>
<span class="sd">            python list or 1d numpy array, The labels for each bonds. If ignore, the constucted UniTensor will using the default labels for each bond.</span>

<span class="sd">    Return:</span>
<span class="sd">        UniTensor</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; x = torch.ones(3,3)</span>
<span class="sd">        &gt;&gt;&gt; print(x)</span>
<span class="sd">        tensor([[1., 1., 1.],</span>
<span class="sd">                [1., 1., 1.],</span>
<span class="sd">                [1., 1., 1.]])</span>

<span class="sd">        &gt;&gt;&gt; y = tor10.From_torch(x,rowrank=1,labels=[4,5])</span>
<span class="sd">        &gt;&gt;&gt; y.Print_diagram()</span>
<span class="sd">        -----------------------</span>
<span class="sd">        tensor Name : </span>
<span class="sd">        tensor Rank : 2</span>
<span class="sd">        has_symmetry: False</span>
<span class="sd">        on device     : cpu</span>
<span class="sd">        is_diag       : False</span>
<span class="sd">                    -------------      </span>
<span class="sd">                   /             \     </span>
<span class="sd">             4 ____| 3         3 |____ 5  </span>
<span class="sd">                   \             /     </span>
<span class="sd">                    -------------  </span>

<span class="sd">        &gt;&gt;&gt; print(y)</span>
<span class="sd">        Tensor name:</span>
<span class="sd">        is_diag    : False</span>
<span class="sd">        tensor([[1., 1., 1.],</span>
<span class="sd">                [1., 1., 1.],</span>
<span class="sd">                [1., 1., 1.]])</span>


<span class="sd">        &gt;&gt;&gt; x2 = torch.ones(3,4,requires_grad=True)</span>
<span class="sd">        &gt;&gt;&gt; print(x2)</span>
<span class="sd">        tensor([[1., 1., 1., 1.],</span>
<span class="sd">                [1., 1., 1., 1.],</span>
<span class="sd">                [1., 1., 1., 1.]], requires_grad=True)</span>

<span class="sd">        &gt;&gt;&gt; y2 = tor10.From_torch(x2,rowrank=1)</span>
<span class="sd">        &gt;&gt;&gt; print(y2.requires_grad())</span>
<span class="sd">        True</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">torch_tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;From_torch&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] can only accept torch.Tensor&quot;</span><span class="p">)</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">torch_tensor</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">rowrank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rowrank</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rowrank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;From_torch&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] rowrank exceed the rank of input torch tensor.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;From_torch&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] rowrank must be set for a non rank-0 tensor&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;From_torch&quot;</span><span class="p">,</span> <span class="s2">&quot;[ERROR] # of labels should match the rank of torch.Tensor&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_tag</span><span class="p">:</span>

        <span class="n">new_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">BD_KET</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowrank</span><span class="p">)]</span> <span class="o">+</span> \
                    <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">BD_BRA</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rowrank</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="p">[],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[],</span> <span class="n">rowrank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">torch_tensor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">UniTensor</span><span class="p">(</span><span class="n">bonds</span><span class="o">=</span><span class="n">new_bonds</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">rowrank</span><span class="o">=</span><span class="n">rowrank</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">_mac</span><span class="p">(</span><span class="n">torch_tensor</span><span class="o">=</span><span class="n">torch_tensor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Kai-Hsin Wu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>